/*========================================================================*/
/* NOM DU FICHIER  : vexploitDhcpClient.c                                 */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 18/01/2010                                           */
/* Libelle         : HTML CGI: page HTML exploitation DHCP clients		  */
/* Projet          : WRM100                                               */
/* Indice          : BE014                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE005 18/01/2010 CM
// - CREATION
//BE014 08/03/2010 CM
// - Ajout option compilation "-Wall" + correction w@rning
/*========================================================================*/


/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/

#define _VEXPLOITDHCPCLIENT


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../services.h"

/*_____IV - VARIABLES GLOBALES ___________________________________________*/

/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: VExploitDhcpClient_Dyn
// Entrees		: <loc_p_varlist< : liste des paramètres URL
//				  <loc_s32_form_method> : méthode du formulaire
// Sortie		: Rien
// Auteur		: CM - 18/01/2010
// Description	: Page rafraichissement page Exploit DHCP Client
//				"URL=VExploitDhcpClient_Dyn
//=====================================================================================
void VExploitDhcpClient_Dyn(s8sod **loc_p_varlist, s32sod loc_s32_form_method)
{
	s32sod				loc_s32_sem;

//	printf("Content-type: text/html\n\n");/* Mandatory */
	printf("Content-type: text/plain\n\n");/* Mandatory */

	// Entrée au setup par mot de passe
	if(!TestClientIpConnecte(getenv("REMOTE_ADDR")))
	{
		html_tag("|");
		html_tag("&&&id:RECHARGER_PAGE_HTML&&&"); //id inconnu donc recharge de la page
	}
	
	s32Lock_Get(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillConfigGeneral(&s_html_cfg_eqpmt))
	{
		html_tag("|");
		html_tag("&&&id:RECHARGER_PAGE_HTML&&&"); //id inconnu donc recharge de la page
	}
	s32Lock_Release(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on relache le sem


	s32Lock_Get(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillExploitDHCPFile(&s_html_exploit.s_dhcp))
	{
		html_tag("|");
		html_tag("&&&id:RECHARGER_PAGE_HTML&&&"); //id inconnu donc recharge de la page
	}
	s32Lock_Release(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on relache le sem

	//Page accéssible uniquement en mode STATION / router
	if((MODE_RADIO_MODEM_STATION != s_html_cfg_eqpmt.s_gene.u8_mode_radio_modem) ||
	   (MODE_NETWORK_ROUTER != s_html_cfg_eqpmt.s_gene.u8_mode_network)
	  )//CONDITION: STATION / router
	{
		html_tag("|");
		html_tag("&&&id:RECHARGER_PAGE_HTML&&&"); //id inconnu donc recharge de la page
	}

	if(FCT_DHCP_SERVER == s_html_cfg_eqpmt.s_gene.u8_lan_fonction_dhcp)
	{
		if(0 != s_html_exploit.s_dhcp.u16_nb_clients) //CONDITION: pas de client DHCP
		{
			HtmlDyn_TableClientDhcp();
		}
		
		//On surveille le nombre de clients DHCP connectés
		html_tag("|");
		html_tag("&&&id:SPAN_NB_CLIENTS_DHCP_%d&&&innerHTML:&&&",
				 s_html_exploit.s_dhcp.u16_nb_clients);
	}
	
	//On surveille le nombre de clients DHCP connectés
	html_tag("|");
	html_tag("&&&id:SPAN_FCT_DHCP%d&&&innerHTML:&&&",
			 s_html_cfg_eqpmt.s_gene.u8_lan_fonction_dhcp);
	
	html_tag("|");

	
}/*VExploitDhcpClient_Dyn*/

//=====================================================================================
// Fonction		: HtmlDyn_TableClientDhcp
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 18/01/2010
// Description	: Code HTML de la table des clients DHCP (dynamique)
//=====================================================================================
void HtmlDyn_TableClientDhcp(void)
{
	u16sod loc_u16_i;

	for(loc_u16_i=0;loc_u16_i<NB_MAX_CLIENTS_DHCP;loc_u16_i++)
	{
		if(TRUE == s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].u8_present)
		{
			html_tag("|");
			html_tag("&&&id:SPAN_CLIENT_DHCP%d&&&innerHTML:%-30s%-20s%lu&&&",
					 loc_u16_i,
					 ps8GetChAddressMac(s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].pu8_add_mac),
					 ps8GetStringIp(s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].u32_adresse_ip),
					 s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].u32_temps_restant);
		}
	}

}/*HtmlDyn_TableClientDhcp*/

//=====================================================================================
// Fonction		: VExploitDhcpClient
// Entrees		: <loc_p_varlist< : liste des paramètres URL
//				  <loc_s32_form_method> : méthode du formulaire
// Sortie		: Rien
// Auteur		: CM - 18/01/2010
// Description	: Page HTML Exploitation: Paramètres DHCP client
//				"URL=VExploitDhcpClient"
//=====================================================================================
void VExploitDhcpClient(s8sod **loc_p_varlist, s32sod loc_s32_form_method)
{
	s32sod				loc_s32_sem;

	printf("Content-type: text/html\n\n");/* Mandatory */
	
	// Entrée au setup par mot de passe
	if(!TestPassword(getenv("REMOTE_ADDR"), LOW_LEVEL_ACCESS))
	{
		PreparePagePswd("VExploitDhcpClient");
		return;
	}

	//Lecture de la base de données
	s32Lock_Get(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillConfigGeneral(&s_html_cfg_eqpmt))
	{
		u8_html_base_donnees_inaccessible = TRUE; //defaut accès bdd
	}
	s32Lock_Release(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on relache le sem


	s32Lock_Get(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillExploitDHCPFile(&s_html_exploit.s_dhcp))
	{
		u8_html_base_donnees_inaccessible = TRUE; //defaut accès bdd
	}
	s32Lock_Release(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on relache le sem

	//Test si accès au contenu page 
	if(FALSE == u8TestStartHtml()) //CONDITION: accès au contenu page HTML immpossible
	{
		return; // on sort!
	}

	//Page accéssible uniquement en mode STATION / router
	if((MODE_RADIO_MODEM_STATION != s_html_cfg_eqpmt.s_gene.u8_mode_radio_modem) ||
	   (MODE_NETWORK_ROUTER != s_html_cfg_eqpmt.s_gene.u8_mode_network)
	  )//CONDITION: STATION / router
	{
		sprintf(ps8_pageHtmlRetour,"/cgi-bin/cgi_fh?URL=Vwarning&%d",
				WARNING_MODE_ONLY_STATION_ROUTER);
		Html_GotoPage(ps8_pageHtmlRetour);
		return;
	}
	

	html_tag("<html> \n");
	html_tag("<head> \n");
	html_tag("<title>%s: %s</title> \n",
			 pt_tb_msg[u8_html_langue].ps8_msg_exploitation,
			 pt_tb_msg[u8_html_langue].ps8_msg_dhcp_clients);
	html_tag("<LINK href=\"../style.css\" type=text/css rel=stylesheet></LINK> \n");
	html_tag ("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\"> \n");
	html_tag ("<meta http-equiv=\"Pragma\" content=\"no-cache\"> \n");
	html_tag ("<meta http-equiv=\"Expires\" content=\"-1\"> \n");
	html_tag("</head> \n");

	html_tag("<body> \n");

	JSActualiser("/cgi-bin/cgi_fh?URL=VExploitDhcpClient");	//pour la fonction Actualiser
	RefreshContentsOfFrame("/cgi-bin/cgi_fh?URL=VExploitDhcpClient_Dyn", (u32sod)u16GetTpsRefreshHtml()*1000);
	

	html_tag("<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"580\"> \n");
	html_tag("<TR><TD vAlign=top height=40><P class=header>%s: %s</P></TD></TR> \n",
			 pt_tb_msg[u8_html_langue].ps8_msg_exploitation,
			 pt_tb_msg[u8_html_langue].ps8_msg_dhcp_clients);
	html_tag("<tr><td><P>%s</P></td></tr> \n",
			 pt_tb_msg[u8_html_langue].ps8_msg_sous_titre_VExploitDhcpClient);
	html_tag("<tr><td>&nbsp;</td></tr> \n");

	
	//	===========================================
	//	AFFICHAGE D'INFORMATIONS
	//	communes à toutes les pages HTML
	//	===========================================
	AfficheDansToutesLesPages();

#if 0
	html_tag("<tr><td><P class=undermenu>&nbsp;</P></td></tr> \n");

	if(TRUE == u8TestGroupeEvtDisponible(GROUPE_AL_ASI))
	{
		html_tag("<tr><td><table  align=center border=\"1\" cellpadding=\"2\" cellspacing=\"1\"> \n");
		html_tag("	<tr height=20> \n");
		html_tag("   <th width=200><a href=\"/cgi-bin/cgi_fh?URL=VAlarme&param=%d\" target=\"frame_c\">%s</a></th> \n",
				 GROUPE_AL_ASI,
				 pt_tb_msg[u8_html_langue].ps8_msg_lib_groupe_alarmes[GROUPE_AL_ASI]);
		HtmlTD_ConvStatAlarme(u8GetEtatGroupeAlarme(GROUPE_AL_ASI),"GROUPE_AL_ASI",100);
		html_tag("	</tr>\n");
		html_tag("</table></td></tr>\n");
		html_tag("<tr><td>&nbsp;</td></tr> \n");
		html_tag("<tr><td>&nbsp;</td></tr> \n");
	}
	else
	{
		html_tag("<tr><td>&nbsp;</td></tr> \n");
	}
#endif


	html_tag("<tr><td><B>%s:</B>&nbsp;%s</td></tr> \n",
			pt_tb_msg[u8_html_langue].ps8_msg_fonction_dhcp,
			pt_tb_msg[u8_html_langue].ps8_msg_choix_fct_dhcp[s_html_cfg_eqpmt.s_gene.u8_lan_fonction_dhcp]);
	
	if(FCT_DHCP_SERVER == s_html_cfg_eqpmt.s_gene.u8_lan_fonction_dhcp)
	{
		html_tag("<tr><td><P class=undermenu>%s</P></td></tr> \n",
				 pt_tb_msg[u8_html_langue].ps8_msg_liste_clients_dhcp);
		html_tag("<tr><td>&nbsp;</td></tr> \n");
		if(0 == s_html_exploit.s_dhcp.u16_nb_clients) //CONDITION: pas de client DHCP
		{
			html_tag("<tr><td>&nbsp;&nbsp;%s</td></tr> \n",
					pt_tb_msg[u8_html_langue].ps8_msg_aucun_client_dhcp);
		}
		else
		{
			html_tag("<tr><td>\n");
			html_tag("<pre>");
			HtmlPrint_TableClientDhcp();
			html_tag("</pre>\n");
			html_tag("</td></tr> \n");
		}

		//On surveille le nombre de clients DHCP connectés
		html_tag("<span id=SPAN_NB_CLIENTS_DHCP_%d></span> \n",
				 s_html_exploit.s_dhcp.u16_nb_clients);
	}
	
	//On surveille le statut IP de l'adresse WLAN
	html_tag("<span id=SPAN_FCT_DHCP%d></span> \n",
			 s_html_cfg_eqpmt.s_gene.u8_lan_fonction_dhcp);


	html_tag("<tr><td>&nbsp;</td></tr> \n");
	html_tag("</table> \n");
	html_tag("</body> \n");
	html_tag("</html> \n");

}/*VExploitDhcpClient*/

//=====================================================================================
// Fonction		: HtmlPrint_TableClientDhcp
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 18/01/2010
// Description	: Code HTML de la table des clients DHCP
//=====================================================================================
void HtmlPrint_TableClientDhcp(void)
{
	u16sod loc_u16_i;

	html_tag("<B>%-30s%-20s%-30s </B>\n",
			 pt_tb_msg[u8_html_langue].ps8_msg_adresse_MAC,
			 pt_tb_msg[u8_html_langue].ps8_msg_adresse_ip,
			 pt_tb_msg[u8_html_langue].ps8_msg_bail_restant);
	
	for(loc_u16_i=0;loc_u16_i<NB_MAX_CLIENTS_DHCP;loc_u16_i++)
	{
		if(TRUE == s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].u8_present)
		{
			html_tag("<span id=SPAN_CLIENT_DHCP%d>%-30s%-20s%lu</span> \n",
					 loc_u16_i,
					 ps8GetChAddressMac(s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].pu8_add_mac),
					 ps8GetStringIp(s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].u32_adresse_ip),
					 s_html_exploit.s_dhcp.s_client_connected[loc_u16_i].u32_temps_restant);
		}
	}
	
}/*HtmlPrint_TableClientDhcp*/

/*_____VI - PROCEDURE D'INITIALISATION ___________________________________*/

//=====================================================================================
// Fonction		: InitModule_VExploitDhcpClient
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 18/01/2010
// Description	: Initialisation du module de VExploitDhcpClient
//=====================================================================================
void InitModule_VExploitDhcpClient(void)
{
}/*InitModule_VExploitDhcpClient*/
