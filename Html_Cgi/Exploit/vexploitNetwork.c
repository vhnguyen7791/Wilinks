/*========================================================================*/
/* NOM DU FICHIER  : vexploitNetwork.c	                                  */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 12/01/2010                                           */
/* Libelle         : HTML CGI: page HTML exploitation Réseau			  */
/* Projet          : WRM100                                               */
/* Indice          : BE010                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE003 12/01/10 CM
// - CREATION
//BE010 03/02/2010 CM
// - Ajout information statut IP des interfaces
/*========================================================================*/


/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/

#define _VEXPLOITNETWORK


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../services.h"

/*_____IV - VARIABLES GLOBALES ___________________________________________*/

/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: VExploitNetwork_Dyn
// Entrees		: <loc_p_varlist< : liste des paramètres URL
//				  <loc_s32_form_method> : méthode du formulaire
// Sortie		: Rien
// Auteur		: CM - 12/01/2010
// Description	: Page rafraichissement page Exploit Réseau
//				"URL=VExploitNetwork_Dyn
//=====================================================================================
void VExploitNetwork_Dyn(s8sod **loc_p_varlist, s32sod loc_s32_form_method)
{
	s32sod				loc_s32_sem;

//	printf("Content-type: text/html\n\n");/* Mandatory */
	printf("Content-type: text/plain\n\n");/* Mandatory */

	// Entrée au setup par mot de passe
	if(!TestClientIpConnecte(getenv("REMOTE_ADDR")))
	{
		html_tag("|");
		html_tag("&&&id:RECHARGER_PAGE_HTML&&&"); //id inconnu donc recharge de la page
	}
	
	s32Lock_Get(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillConfigGeneral(&s_html_cfg_eqpmt))
	{
		html_tag("|");
		html_tag("&&&id:RECHARGER_PAGE_HTML&&&"); //id inconnu donc recharge de la page
	}
	s32Lock_Release(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on relache le sem

	s32Lock_Get(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillExploitGeneralFile(&s_html_exploit.s_general))
	{
		html_tag("|");
		html_tag("&&&id:RECHARGER_PAGE_HTML&&&"); //id inconnu donc recharge de la page
	}
	s32Lock_Release(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on relache le sem
	
	//On surveille le mode réseau
	html_tag("|");
	html_tag("&&&id:SPAN_MODE_RESEAU%d&&&innerHTML:&&&",
			 s_html_cfg_eqpmt.s_gene.u8_mode_network);

	if(MODE_NETWORK_BRIDGE == s_html_cfg_eqpmt.s_gene.u8_mode_network)
	{
		if(MODE_IP_DHCP_CLIENT == s_html_cfg_eqpmt.s_gene.u8_bridge_mode_ip)
		{
			//Statut IP du Bridge
			html_tag("|");
			html_tag("&&&id:SPAN_STATUT_IP_BRIDGE&&&innerHTML:%s&&&",
					 ps8ConvertChaineToHtml(pt_tb_msg[u8_html_langue].ps8_msg_choix_statut_ip[s_html_exploit.s_general.ps_interface[INTERFACE_LAN].u8_statut_ip]));
		}
	}
	
	//Adresse IP LAN
	html_tag("|");
	html_tag("&&&id:SPAN_ADDR_IP_LAN&&&innerHTML:%s&&&",
			 s_html_exploit.s_general.ps_interface[INTERFACE_LAN].ps8_add_ip);

	if(MODE_NETWORK_ROUTER == s_html_cfg_eqpmt.s_gene.u8_mode_network)
	{
		if(MODE_IP_DHCP_CLIENT == s_html_cfg_eqpmt.s_gene.u8_wlan_mode_ip)
		{
			//Statut IP du WLAN
			html_tag("|");
			html_tag("&&&id:SPAN_STATUT_IP_WLAN&&&innerHTML:%s&&&",
					 ps8ConvertChaineToHtml(pt_tb_msg[u8_html_langue].ps8_msg_choix_statut_ip[s_html_exploit.s_general.ps_interface[INTERFACE_WLAN].u8_statut_ip]));
		}
	}
	
	//Adresse IP WLAN
	html_tag("|");
	html_tag("&&&id:SPAN_ADDR_IP_WLAN&&&innerHTML:%s&&&",
			 s_html_exploit.s_general.ps_interface[INTERFACE_WLAN].ps8_add_ip);
	
	html_tag("|");

	
}/*VExploitNetwork_Dyn*/

//=====================================================================================
// Fonction		: VExploitNetwork
// Entrees		: <loc_p_varlist< : liste des paramètres URL
//				  <loc_s32_form_method> : méthode du formulaire
// Sortie		: Rien
// Auteur		: CM - 12/01/2010
// Description	: Page HTML Exploitation: Paramètres Réseau
//				"URL=VExploitNetwork"
//=====================================================================================
void VExploitNetwork(s8sod **loc_p_varlist, s32sod loc_s32_form_method)
{
	s32sod				loc_s32_sem;

	printf("Content-type: text/html\n\n");/* Mandatory */
	
	// Entrée au setup par mot de passe
	if(!TestPassword(getenv("REMOTE_ADDR"), LOW_LEVEL_ACCESS))
	{
		PreparePagePswd("VExploitNetwork");
		return;
	}

	//Lecture de la base de données
	s32Lock_Get(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillConfigGeneral(&s_html_cfg_eqpmt))
	{
		u8_html_base_donnees_inaccessible = TRUE; //defaut accès bdd
	}
	s32Lock_Release(SEMAPHORE_BDD_CONFIG_EQPT, &loc_s32_sem);	//on relache le sem


	s32Lock_Get(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on lève le sémaphore
	if(FALSE == u8FillExploitGeneralFile(&s_html_exploit.s_general))
	{
		u8_html_base_donnees_inaccessible = TRUE; //defaut accès bdd
	}
	s32Lock_Release(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on relache le sem

	//Test si accès au contenu page 
	if(FALSE == u8TestStartHtml()) //CONDITION: accès au contenu page HTML immpossible
	{
		return; // on sort!
	}
	
	

	html_tag("<html> \n");
	html_tag("<head> \n");
	html_tag("<title>%s: %s</title> \n",
			 pt_tb_msg[u8_html_langue].ps8_msg_exploitation,
			 pt_tb_msg[u8_html_langue].ps8_msg_reseau);
	html_tag("<LINK href=\"../style.css\" type=text/css rel=stylesheet></LINK> \n");
	html_tag ("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\"> \n");
	html_tag ("<meta http-equiv=\"Pragma\" content=\"no-cache\"> \n");
	html_tag ("<meta http-equiv=\"Expires\" content=\"-1\"> \n");
	html_tag("</head> \n");

	html_tag("<body> \n");

	JSActualiser("/cgi-bin/cgi_fh?URL=VExploitNetwork");	//pour la fonction Actualiser
	RefreshContentsOfFrame("/cgi-bin/cgi_fh?URL=VExploitNetwork_Dyn", (u32sod)u16GetTpsRefreshHtml()*1000);
	

	html_tag("<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"580\"> \n");
	html_tag("<TR><TD vAlign=top height=40><P class=header>%s: %s</P></TD></TR> \n",
			 pt_tb_msg[u8_html_langue].ps8_msg_exploitation,
			 pt_tb_msg[u8_html_langue].ps8_msg_reseau);
	html_tag("<tr><td><P>%s</P></td></tr> \n",
			 pt_tb_msg[u8_html_langue].ps8_msg_sous_titre_VExploitNetwork);
	html_tag("<tr><td>&nbsp;</td></tr> \n");

	//	===========================================
	//	AFFICHAGE D'INFORMATIONS
	//	communes à toutes les pages HTML
	//	===========================================
	AfficheDansToutesLesPages();

#if 0
	html_tag("<tr><td><P class=undermenu>&nbsp;</P></td></tr> \n");

	if(TRUE == u8TestGroupeEvtDisponible(GROUPE_AL_ASI))
	{
		html_tag("<tr><td><table  align=center border=\"1\" cellpadding=\"2\" cellspacing=\"1\"> \n");
		html_tag("	<tr height=20> \n");
		html_tag("   <th width=200><a href=\"/cgi-bin/cgi_fh?URL=VAlarme&param=%d\" target=\"frame_c\">%s</a></th> \n",
				 GROUPE_AL_ASI,
				 pt_tb_msg[u8_html_langue].ps8_msg_lib_groupe_alarmes[GROUPE_AL_ASI]);
		HtmlTD_ConvStatAlarme(u8GetEtatGroupeAlarme(GROUPE_AL_ASI),"GROUPE_AL_ASI",100);
		html_tag("	</tr>\n");
		html_tag("</table></td></tr>\n");
		html_tag("<tr><td>&nbsp;</td></tr> \n");
		html_tag("<tr><td>&nbsp;</td></tr> \n");
	}
	else
	{
		html_tag("<tr><td>&nbsp;</td></tr> \n");
	}
#endif


	//On surveille le mode réseau
	html_tag("<span id=SPAN_MODE_RESEAU%d></span> \n",
			 s_html_cfg_eqpmt.s_gene.u8_mode_network);
	
	html_tag("<tr><td><P class=undermenu>&nbsp;</P></td></tr> \n");
	html_tag("<tr><td><table border=\"0\"> \n");
	//Mode réseau
	html_tag("	<tr>\n");
	html_tag("		<td nowrap><B>%s</B></td>\n",
			 pt_tb_msg[u8_html_langue].ps8_msg_mode_reseau);
	html_tag("		<td><B>:</B></td>\n");
	html_tag("		<td>&nbsp;%s</td>\n",
			 pt_tb_msg[u8_html_langue].ps8_msg_choix_mode_reseau[s_html_cfg_eqpmt.s_gene.u8_mode_network]);
	html_tag("	</tr>\n");
	if(MODE_NETWORK_BRIDGE == s_html_cfg_eqpmt.s_gene.u8_mode_network)
	{
		//Mode IP du bridge
		html_tag("	<tr>\n");
		html_tag("		<td nowrap><B>%s</B></td>\n",
				 pt_tb_msg[u8_html_langue].ps8_msg_mode_ip);
		html_tag("		<td><B>:</B></td>\n");
		html_tag("		<td>&nbsp;%s</td>\n",
				 pt_tb_msg[u8_html_langue].ps8_msg_choix_mode_ip[s_html_cfg_eqpmt.s_gene.u8_bridge_mode_ip]);
		html_tag("	</tr>\n");
		if(MODE_IP_DHCP_CLIENT == s_html_cfg_eqpmt.s_gene.u8_bridge_mode_ip)
		{
			//Statut IP du Bridge
			html_tag("	<tr>\n");
			html_tag("		<td nowrap><B>%s</B></td>\n",
					 pt_tb_msg[u8_html_langue].ps8_msg_statut_ip);
			html_tag("		<td><B>:</B></td>\n");
			html_tag("		<td>&nbsp;<SPAN id=SPAN_STATUT_IP_BRIDGE>%s</span></td>\n",
					 pt_tb_msg[u8_html_langue].ps8_msg_choix_statut_ip[s_html_exploit.s_general.ps_interface[INTERFACE_LAN].u8_statut_ip]);
			html_tag("	</tr>\n");
		}
	}
	html_tag("<tr><td>&nbsp;</td></tr> \n");
	//Adresse MAC LAN
	html_tag("	<tr>\n");
	html_tag("		<td nowrap><B>%s</B></td>\n",
			 pt_tb_msg[u8_html_langue].ps8_msg_adresse_mac_ethernet);
	html_tag("		<td><B>:</B></td>\n");
	html_tag("		<td>&nbsp;%s</td>\n",
			 ps8GetChAddressMac(s_html_exploit.s_general.ps_interface[INTERFACE_LAN].pu8_add_mac));
	html_tag("	</tr>\n");
	//Adresse IP LAN
	html_tag("	<tr>\n");
	html_tag("		<td nowrap><B>%s</B></td>\n",
			 pt_tb_msg[u8_html_langue].ps8_msg_adresse_ip_ethernet);
	html_tag("		<td><B>:</B></td>\n");
	html_tag("		<td>&nbsp;<SPAN id=SPAN_ADDR_IP_LAN>%s</span></td>\n",
			 s_html_exploit.s_general.ps_interface[INTERFACE_LAN].ps8_add_ip);
	html_tag("	</tr>\n");
	html_tag("<tr><td>&nbsp;</td></tr> \n");
	//Adresse MAC WLAN
	html_tag("	<tr>\n");
	html_tag("		<td nowrap><B>%s</B></td>\n",
			 pt_tb_msg[u8_html_langue].ps8_msg_adresse_mac_wifi);
	html_tag("		<td><B>:</B></td>\n");
	html_tag("		<td>&nbsp;%s</td>\n",
			 ps8GetChAddressMac(s_html_exploit.s_general.ps_interface[INTERFACE_WLAN].pu8_add_mac));
	html_tag("	</tr>\n");
	if(MODE_NETWORK_ROUTER == s_html_cfg_eqpmt.s_gene.u8_mode_network)
	{
		//Mode IP du WLAN
		html_tag("	<tr>\n");
		html_tag("		<td nowrap><B>%s</B></td>\n",
				 pt_tb_msg[u8_html_langue].ps8_msg_mode_ip);
		html_tag("		<td><B>:</B></td>\n");
		html_tag("		<td>&nbsp;%s</td>\n",
				 pt_tb_msg[u8_html_langue].ps8_msg_choix_mode_ip[s_html_cfg_eqpmt.s_gene.u8_wlan_mode_ip]);
		html_tag("	</tr>\n");
		if(MODE_IP_DHCP_CLIENT == s_html_cfg_eqpmt.s_gene.u8_wlan_mode_ip)
		{
			//Statut IP du WLAN
			html_tag("	<tr>\n");
			html_tag("		<td nowrap><B>%s</B></td>\n",
					 pt_tb_msg[u8_html_langue].ps8_msg_statut_ip);
			html_tag("		<td><B>:</B></td>\n");
			html_tag("		<td>&nbsp;<SPAN id=SPAN_STATUT_IP_WLAN>%s</span></td>\n",
					 pt_tb_msg[u8_html_langue].ps8_msg_choix_statut_ip[s_html_exploit.s_general.ps_interface[INTERFACE_WLAN].u8_statut_ip]);
			html_tag("	</tr>\n");
		}
	}
	//Adresse IP WLAN
	html_tag("	<tr>\n");
	html_tag("		<td nowrap><B>%s</B></td>\n",
			 pt_tb_msg[u8_html_langue].ps8_msg_adresse_ip_wifi);
	html_tag("		<td><B>:</B></td>\n");
	html_tag("		<td>&nbsp;<SPAN id=SPAN_ADDR_IP_WLAN>%s</span></td>\n",
			 s_html_exploit.s_general.ps_interface[INTERFACE_WLAN].ps8_add_ip);
	html_tag("	</tr>\n");
	html_tag("</table></td></tr>\n");
	html_tag("<tr><td>&nbsp;</td></tr> \n");
	

	html_tag("<tr><td>&nbsp;</td></tr> \n");
	html_tag("</table> \n");
	html_tag("</body> \n");
	html_tag("</html> \n");

}/*VExploitNetwork*/

/*_____VI - PROCEDURE D'INITIALISATION ___________________________________*/

//=====================================================================================
// Fonction		: InitModule_VExploitNetwork
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 12/01/2010
// Description	: Initialisation du module de VExploitNetwork
//=====================================================================================
void InitModule_VExploitNetwork(void)
{
}/*InitModule_VExploitNetwork*/
