/*========================================================================*/
/* NOM DU FICHIER  : exploit.c			                                  */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 07/06/2007                                           */
/* Libelle         : Base de données: gestion de l'exploitation			  */
/* Projet          : WRM100                                               */
/* Indice          : BE060                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE000 09/09/09 CM
// - CREATION
//BE003 22/12/2009 CM
// - Ajout exploitation adresse IP/Mask des interfaces
//BE005 14/01/2010 CM
// - Intégration serveur DHCP + relai DHCP
//BE007 25/01/2010 CM
// - Ajout exploitation de l'ACCESS POINT
//BE010 03/02/2010 CM
// - Ajout information statut IP des interfaces
//BE024 03/04/2010 CM
// - Correction suite revue de codage de Caf (sur BE023)
//BE031.3 08/06/2010 JP
// - dans la page test production final, l'etat de la connexion de la station est memorise avec code couleur (rouge, orange,vert)
//BE037 06/07/2010 CM
// - Ajout récupération statut ethernet des 2 ports ethernet
// - Ajout exploitation temperature 
// - Ajout exploitation du client NTP
//BE042 07/10/2010 CM
// - Definition macro RSSI => dBm (et inverse)
//BE046 17/11/2010 CM
// - Correction alarme Ethernet pour chaque accès
//	alarme ethernet lan 1 et alarme ethernet lan 2
//	L'alarme "ethernet lan 2" est non validée par défaut
//	+ aussi disponible sur ACCESS POINT
// - Correction force horodatage identique à tous les évènements dans la seconde
//BE047 29/11/2010 CM
// - Gestion mode dégradé - connection à AP impossible en permanence suite à configuration wifi 
//BE050 09/12/2010 CM
// - Correction gestion NTP/SNTP
//BE051 13/12/2010 CM
// - Ajout exploitation SSID (utile si dual ssid activé)
//BE058 21/01/2011 CM
// - Ajout dans exploitation du canal en cours (sur AP et STA)
//BE060 16/03/2011
// - DEP: Ajout des évenements de connexion et déconnexion d'une STATION
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/


/*_____II - DEFINE SBIT __________________________________________________*/

#define _EXPLOIT

/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../Include/headers.h"
#include "headers.h"

/*_____IV - VARIABLES GLOBALES ___________________________________________*/


/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: u8FillExploitGeneralFile
// Entrees		: <loc_ps_exploit_gene> : pointeur sur exploit générale à initialiser
// Sortie		: <loc_u8_resultat>	: Lecture OK(si TRUE), sinon FALSE
// Auteur		: CM - 28/09/2009 -
// Description	: Lecture du fichier d'exploitation générale
//=====================================================================================
u8sod u8FillExploitGeneralFile(S_STRUC_EXP_GENERAL *loc_ps_exploit_gene)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_FileToStruct(loc_ps_exploit_gene, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_GENERAL_EXP ]);

	return loc_u8_resultat;
}/*u8FillExploitGeneralFile*/

//=====================================================================================
// Fonction		: u8EditExploitGeneralFile
// Entrees		: <loc_ps_exploit_gene> : pointeur sur exploit générale à initialiser
// Sortie		: <loc_u8_resultat>	: ecriture OK(si TRUE), sinon FALSE
// Auteur		: CM - 28/09/2009 -
// Description	: Ecriture  du fichier d'exploitation générale
//=====================================================================================
u8sod u8EditExploitGeneralFile(S_STRUC_EXP_GENERAL *loc_ps_exploit_gene)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_StructToFile(loc_ps_exploit_gene, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_GENERAL_EXP ]);

	return loc_u8_resultat;
}/*u8EditExploitGeneralFile*/

//=====================================================================================
// Fonction		: u8FillExploitStationFile
// Entrees		: <loc_ps_exploit_station> : pointeur sur exploit station à initialiser
// Sortie		: <loc_u8_resultat>	: Lecture OK(si TRUE), sinon FALSE
// Auteur		: CM - 26/10/2009 -
// Description	: Lecture du fichier d'exploitation station
//=====================================================================================
u8sod u8FillExploitStationFile(S_STRUCT_EXP_STATION *loc_ps_exploit_station)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_FileToStruct(loc_ps_exploit_station, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_STATION_EXP ]);

	return loc_u8_resultat;
}/*u8FillExploitStationFile*/

//=====================================================================================
// Fonction		: u8EditExploitStationFile
// Entrees		: <loc_ps_exploit_station> : pointeur sur exploit station à initialiser
// Sortie		: <loc_u8_resultat>	: ecriture OK(si TRUE), sinon FALSE
// Auteur		: CM - 26/10/2009 -
// Description	: Ecriture  du fichier d'exploitation station
//=====================================================================================
u8sod u8EditExploitStationFile(S_STRUCT_EXP_STATION *loc_ps_exploit_station)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_StructToFile(loc_ps_exploit_station, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_STATION_EXP ]);

	return loc_u8_resultat;
}/*u8EditExploitStationFile*/

//=====================================================================================
// Fonction		: u8FillExploitAccessPointFile
// Entrees		: <loc_ps_exploit_accesspoint> : pointeur sur exploit access point à initialiser
// Sortie		: <loc_u8_resultat>	: Lecture OK(si TRUE), sinon FALSE
// Auteur		: CM - 09/11/2009 -
// Description	: Lecture du fichier d'exploitation access point
//=====================================================================================
u8sod u8FillExploitAccessPointFile(S_STRUC_EXP_ACCESS_POINT *loc_ps_exploit_accesspoint)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_FileToStruct(loc_ps_exploit_accesspoint, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_ACCESSPOINT_EXP ]);

	return loc_u8_resultat;
}/*u8FillExploitAccessPointFile*/

//=====================================================================================
// Fonction		: u8EditExploitAccessPointFile
// Entrees		: <loc_ps_exploit_station> : pointeur sur exploit access point à initialiser
// Sortie		: <loc_u8_resultat>	: ecriture OK(si TRUE), sinon FALSE
// Auteur		: CM - 09/11/2009 -
// Description	: Ecriture  du fichier d'exploitation access point
//=====================================================================================
u8sod u8EditExploitAccessPointFile(S_STRUC_EXP_ACCESS_POINT *loc_ps_exploit_accesspoint)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_StructToFile(loc_ps_exploit_accesspoint, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_ACCESSPOINT_EXP ]);

	return loc_u8_resultat;
}/*u8EditExploitAccessPointFile*/

//=====================================================================================
// Fonction		: u8FillExploitDHCPFile
// Entrees		: <loc_ps_exploit_dhcp< : pointeur sur exploit dhcp à initialiser
// Sortie		: <loc_u8_resultat>	: Lecture OK(si TRUE), sinon FALSE
// Auteur		: CM - 18/01/2010 -
// Description	: Lecture du fichier d'exploitation DHCP
//=====================================================================================
u8sod u8FillExploitDHCPFile(S_STRUCT_EXP_DHCP *loc_ps_exploit_dhcp)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_FileToStruct(loc_ps_exploit_dhcp, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_DHCP_EXP ]);

	return loc_u8_resultat;
}/*u8FillExploitDHCPFile*/

//=====================================================================================
// Fonction		: u8EditExploitDHCPFile
// Entrees		: <loc_ps_exploit_dhcp< : pointeur sur exploit dhcp à initialiser
// Sortie		: <loc_u8_resultat>	: ecriture OK(si TRUE), sinon FALSE
// Auteur		: CM - 18/01/2010 -
// Description	: Ecriture  du fichier d'exploitation DHCP
//=====================================================================================
u8sod u8EditExploitDHCPFile(S_STRUCT_EXP_DHCP *loc_ps_exploit_dhcp)
{
	u8sod loc_u8_resultat;

	loc_u8_resultat = u8Transfert_StructToFile(loc_ps_exploit_dhcp, &PT_DEF_FILE_EXPLOIT[ ID_FILE_BDD_DHCP_EXP ]);

	return loc_u8_resultat;
}/*u8EditExploitDHCPFile*/

//=====================================================================================
// Fonction		: s32ConvertRssiToDBm
// Entrees		: <loc_s32_valeur_rssi> : valeur RSSI
// Sortie		: <loc_s32_valeur_dbm>	: valeur dBm
// Auteur		: CM - 12/11/2009 -
// Description	: Convertie la valeur RSSI fournie par le driver ATheros en dBm
//		Unlike the other vendors described, Atheros uses a formula to derive dBm.
//			  RSSI_Max = 107 (au lieu de 60 défini par atheros)
//			  Convert % to RSSI
//			  Subtract 95 from RSSI to derive dBm
//			  Notice that this gives a dBm range of 107dBm at 100% and -95dBm at 0%.
//=====================================================================================
s32sod s32ConvertRssiToDBm(s32sod loc_s32_valeur_rssi)
{
	s32sod loc_s32_valeur_dbm;

	loc_s32_valeur_dbm = MACRO_RSSI2DBM(loc_s32_valeur_rssi);

	return loc_s32_valeur_dbm;
}/*s32ConvertRssiToDBm*/

//=====================================================================================
// Fonction		: u8FillExploitEquipement
// Entrees		: >loc_ps_exploit<	: structure concernant l'exploitation de l'équipement
// Sortie		: rien
// Auteur		: CM - 08/03/2010 -
// Description	: Lecture de l'exploitation
//=====================================================================================
u8sod u8FillExploitEquipement(S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	u8sod loc_u8_resultat;
	u8sod loc_u8_idx_expfile;

	loc_u8_resultat = TRUE; //INIT

	for(loc_u8_idx_expfile=0; loc_u8_idx_expfile<NB_MAX_ID_FILES_EXPLOIT; loc_u8_idx_expfile++)
	{
		if(loc_u8_idx_expfile != ID_FILE_EXP_NULL)
		{
			if(FALSE == u8Transfert_FileToStruct(loc_ps_exploit, &PT_DEF_FILE_EXPLOIT[ loc_u8_idx_expfile ]))
			{
				loc_u8_resultat = FALSE;
			}
		}
	}

	return loc_u8_resultat;
}/*u8FillExploitEquipement*/


/*_____VI - PROCEDURE D'INITIALISATION ___________________________________*/

//=====================================================================================
// Fonction		: InitExpInterface
// Entrees		: <loc_ps_exp_interface> : pointeur sur exploit interface
// Sortie		: rien
// Auteur		: CM - 26/10/2009 -
// Description	: Initialisation de l'exploit d'une interface
//=====================================================================================
void InitExpInterface(S_STRUCT_EXP_INTERFACE *loc_ps_exp_interface)
{
	u8sod loc_u8_i;
	
	loc_ps_exp_interface->u8_presence = FALSE; //INIT
	for(loc_u8_i=0;loc_u8_i<ETHER_ADDR_LEN;loc_u8_i++)
	{
		loc_ps_exp_interface->pu8_add_mac[loc_u8_i] = 0x00;	//INIT
	}
	loc_ps_exp_interface->u8_statut_ip = STATUT_IP__UNDEFINED; //INIT
	strcpy(loc_ps_exp_interface->ps8_add_ip, ps8GetStringIp(0));	//INIT
	strcpy(loc_ps_exp_interface->ps8_mask, ps8GetStringIp(0));	//INIT

}/*InitExpInterface*/

//=====================================================================================
// Fonction		: InitExploitGenerale
// Entrees		: <loc_ps_exploit_gene> : pointeur sur exploit générale à initialiser
// Sortie		: rien
// Auteur		: CM - 07/06/2007 -
// Description	: Initialisation de l'exploit générale
//=====================================================================================
void InitExploitGenerale(S_STRUC_EXP_GENERAL *loc_ps_exploit_gene)
{
	u16sod loc_u16_i;
	u8sod loc_u8_i;

	//Versions logicielles
	for(loc_u16_i=0;loc_u16_i<NB_MAX_VERSIONS_LOGICIELLES;loc_u16_i++)
	{
		strcpy(loc_ps_exploit_gene->s_version[loc_u16_i].ps8_message, (const s8sod*)"?");					//INIT
		loc_ps_exploit_gene->s_version[loc_u16_i].u8_info_suppl = INFO_VERSION_NON_UTILISE;	//INIT
	}
	strcpy(loc_ps_exploit_gene->s_version[VERSION_LOGICIELLE_APPLI_CPU].ps8_message, VERSION_OFFICIELLE);	//INIT

	//Version BE U-BOOT
	strcpy(loc_ps_exploit_gene->ps8_version_be_uboot, "");	//INIT

	//Type d'équipement
	loc_ps_exploit_gene->u8_type_equipement = EQUIPEMENT_WRM100;	//INIT
	

	//Options
	for(loc_u16_i=0;loc_u16_i<NB_MAX_OPTIONS;loc_u16_i++)
	{
		loc_ps_exploit_gene->s_option[loc_u16_i].u8_presence = FALSE;	//INIT
	}

	//Présence du serveur NTP
	for(loc_u8_i=0;loc_u8_i<NB_MAX_SERVEURS_NTP;loc_u8_i++)
	{
		loc_ps_exploit_gene->pu8_presence_serveur_ntp[loc_u8_i] = FALSE;	//INIT
	}
	
	//Date dernier reset
	SetDate(&loc_ps_exploit_gene->s_date_dernier_reset_alarme_statut_event, METHODE_SETDATE_SYSTEM);	//INIT

	//Init des interfaces
	for(loc_u8_i=0;loc_u8_i<NB_MAX_INTERFACES;loc_u8_i++)
	{
		InitExpInterface(&loc_ps_exploit_gene->ps_interface[loc_u8_i]);
	}

	for(loc_u8_i=0;loc_u8_i<NB_MAX_PORTS_ETHERNET;loc_u8_i++)
	{
		loc_ps_exploit_gene->u8_link_statut_ethernet[loc_u8_i] = TRUE;	//INIT: par défaut connecté
	}
	
	loc_ps_exploit_gene->s32_temperature = VALEUR_TEMPERATURE_INCONNUE;	//INIT
	
}/*InitExploitGenerale*/

//=====================================================================================
// Fonction		: InitExploitStation
// Entrees		: <loc_ps_exploit_station> : pointeur sur exploit station à initialiser
// Sortie		: rien
// Auteur		: CM - 26/10/2009 -
// Description	: Initialisation de l'exploit station
//=====================================================================================
void InitExploitStation(S_STRUCT_EXP_STATION *loc_ps_exploit_station)
{
	u8sod loc_u8_i;

	loc_ps_exploit_station->u8_statut_connexion = STATUT_CONNEXION__NOT_ASSOCIATED;	//INIT
	loc_ps_exploit_station->u8_old_statut_connexion = STATUT_CONNEXION__NOT_ASSOCIATED;	//INIT
			
	for(loc_u8_i=0;loc_u8_i<ETHER_ADDR_LEN;loc_u8_i++)
	{
		loc_ps_exploit_station->pu8_bssid_add_mac[loc_u8_i] = 0x00;	//INIT
	}
	loc_ps_exploit_station->s32_rssi_dbm = VALEUR_RSSI_MIN; //INIT
	loc_ps_exploit_station->u32_cptsecond_noconnected = 0; //INIT
	strcpy(loc_ps_exploit_station->ps8_ssid_inprogress, "");
	loc_ps_exploit_station->u16_channel_inprogress = CHANNEL_RADIO_DISABLED; //INIT
	loc_ps_exploit_station->u16_freq_MHz_inprogress = 0; //INIT

}/*InitExploitStation*/

//=====================================================================================
// Fonction		: InitExpWifiClient
// Entrees		: <loc_ps_exp_wifi_client> : pointeur sur exploit client wifi à initialiser
// Sortie		: rien
// Auteur		: CM - 09/11/2009 -
// Description	: Initialisation d'un client wifi
//=====================================================================================
void InitExpWifiClient(S_STRUCT_EXP_WIFI_CLIENT *loc_ps_exp_wifi_client)
{
	u8sod loc_u8_i;

	loc_ps_exp_wifi_client->u8_present = FALSE;	//INIT
	loc_ps_exp_wifi_client->u8_flag_maj = FALSE;	//INIT
	for(loc_u8_i=0;loc_u8_i<ETHER_ADDR_LEN;loc_u8_i++)
	{

		loc_ps_exp_wifi_client->pu8_add_mac[loc_u8_i] = 0x00; //INIT
	}
	loc_ps_exp_wifi_client->u32_add_ip = 0;	//INIT
	loc_ps_exp_wifi_client->s32_rssi_dbm = VALEUR_RSSI_MIN;	//INIT
	loc_ps_exp_wifi_client->u32_statut = 0x00000000;	//INIT
	loc_ps_exp_wifi_client->u32_time_reconnexion = 0;	//INIT

}/*InitExpWifiClient*/

//=====================================================================================
// Fonction		: InitExploitAccessPoint
// Entrees		: <loc_ps_exploit_accesspoint> : pointeur sur exploit access point à initialiser
// Sortie		: rien
// Auteur		: CM - 09/11/2009 -
// Description	: Initialisation de l'exploit access point
//=====================================================================================
void InitExploitAccessPoint(S_STRUC_EXP_ACCESS_POINT *loc_ps_exploit_accesspoint)
{
	u8sod loc_u16_i;

	loc_ps_exploit_accesspoint->u16_nb_associations = 0;	//INIT
	
	for(loc_u16_i=0;loc_u16_i<NB_ASSOCIATED_STATIONS_MAX;loc_u16_i++)
	{
		InitExpWifiClient(&loc_ps_exploit_accesspoint->s_wifi_client[loc_u16_i]); //INIT
	}
	loc_ps_exploit_accesspoint->u16_channel_inprogress = CHANNEL_RADIO_DISABLED; //INIT
	loc_ps_exploit_accesspoint->u16_freq_MHz_inprogress = 0; //INIT

}/*InitExploitAccessPoint*/

//=====================================================================================
// Fonction		: InitExpDhcpClientOfServer
// Entrees		: <loc_ps_exp_client_dhcp_connected> : pointeur sur exploit client DHCP connecté à initialiser
// Sortie		: rien
// Auteur		: CM - 18/01/2010 -
// Description	: Initialisation d'un client DHCP du serveur
//=====================================================================================
void InitExpDhcpClientOfServer(S_STRUCT_EXP_CLIENT_DHCP *loc_ps_exp_client_dhcp_connected)
{
	u8sod loc_u8_i;

	loc_ps_exp_client_dhcp_connected->u8_present = FALSE;	//INIT
	loc_ps_exp_client_dhcp_connected->u8_flag_maj = FALSE; //INIT
	for(loc_u8_i=0;loc_u8_i<ETHER_ADDR_LEN;loc_u8_i++)
	{
		loc_ps_exp_client_dhcp_connected->pu8_add_mac[loc_u8_i] = 0x00; //INIT
	}
	loc_ps_exp_client_dhcp_connected->u32_adresse_ip = 0;	//INIT
	loc_ps_exp_client_dhcp_connected->u32_temps_restant = 0;	//INIT

}/*InitExpDhcpClientOfServer*/

//=====================================================================================
// Fonction		: InitExploitDHCP
// Entrees		: <loc_ps_exploit_dhcp> : pointeur sur exploit dhcp à initialiser
// Sortie		: rien
// Auteur		: CM - 18/01/2010 -
// Description	: Initialisation de l'exploit DHCP
//=====================================================================================
void InitExploitDHCP(S_STRUCT_EXP_DHCP *loc_ps_exploit_dhcp)
{
	u16sod loc_u16_i;
	
	//Initialisation des clients du serveur DHCP (interne)
	loc_ps_exploit_dhcp->u8_server_dhcp_full = FALSE;	//INIT
	loc_ps_exploit_dhcp->u16_nb_clients = 0;	//INIT
	for(loc_u16_i=0;loc_u16_i<NB_MAX_CLIENTS_DHCP;loc_u16_i++)
	{
		InitExpDhcpClientOfServer(&loc_ps_exploit_dhcp->s_client_connected[loc_u16_i]); //INIT
	}

}/*InitExploitDHCP*/

//=====================================================================================
// Fonction		: InitBDD_ExploitEquipment
// Entrees		: <loc_ps_exploit< : pointeur sur la base de données à initialiser
// Sortie		: rien
// Auteur		: CM - 07/06/2007 -
// Description	: Initialisation de la base de données de l'exploitation
//=====================================================================================
void InitBDD_ExploitEquipment(S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	s32sod	loc_s32_sem;

	if(loc_ps_exploit != NULL)
	{
		s32Lock_Get(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on lève le sem

		memset(loc_ps_exploit,'\0',sizeof(S_STRUCT_EXPLOITATION));

		//Paramètres d'exploitation générale
		InitExploitGenerale(&loc_ps_exploit->s_general); // INIT
		u8EditExploitGeneralFile(&loc_ps_exploit->s_general); //INIT

		//Paramètres d'exploitation de l'équipement en mode station
		InitExploitStation(&loc_ps_exploit->s_station); // INIT
		u8EditExploitStationFile(&loc_ps_exploit->s_station); //INIT

		//Paramètres d'exploitation de l'équipement en mode access point
		InitExploitAccessPoint(&loc_ps_exploit->s_access_point); // INIT
		u8EditExploitAccessPointFile(&loc_ps_exploit->s_access_point); //INIT

		//Paramètres d'exploitation DHCP
		InitExploitDHCP(&loc_ps_exploit->s_dhcp); // INIT
		u8EditExploitDHCPFile(&loc_ps_exploit->s_dhcp); //INIT
		
		s32Lock_Release(SEMAPHORE_BDD_EXPLOIT, &loc_s32_sem);	//on relache le sem
	}

}/*InitBDD_ExploitEquipment*/

//=====================================================================================
// Fonction		: InitModule_Exploit
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 07/06/2007 -
// Description	: Initialisation du module de Exploit de l'équipement
//=====================================================================================
void InitModule_Exploit(void)
{
	
}/*InitModule_Exploit*/

