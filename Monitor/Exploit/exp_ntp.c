/*========================================================================*/
/* NOM DU FICHIER  : exp_ntp.c	 		                                  */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 08/07/2010                                           */
/* Libelle         : Monitor: exploitation du client NTP				  */
/* Projet          : WRM100                                               */
/* Indice          : BE039                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE037 08/07/2010 CM
// - CREATION
//BE039 26/08/2010 CM
// - Correction bug "Serveur NTP" est détecté par erreur inaccessible
//	 car l'intervalle de temps de l'emission des requetes NTP du client n'est pas constant
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/
#define _EXP_NTP


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../headers.h"

//Fichier d'exploitation NTP
#define FICHIER_NTP_PRESENCE	PATH_DIR__BDD_EXPLOIT	"ntp_presence"
#define NB_MAX_LIGNES_FICHIER_NTP_PRESENCE	2

#define TIME_UNTIL_NEXT_SEND_DISABLED	0xFFFFFFFF
#define TIME_UNTIL_NEXT_SEND_DEFAULT	70 //secondes
#define TIME_LAST_RECEIVED_DISABLED		0
#define TIME_LAST_RECEIVED_EARLY		10	//secondes

#define OFFSET_DETECTION_DEFAUT_PRESENCE_NTP	10	//secondes d'erreur

#define TAILLE_MAX_LIGNE_EXP_NTP	100


/*_____IV - VARIABLES GLOBALES ___________________________________________*/

static u32sod pu32_time_until_next_send[NB_MAX_SERVEURS_NTP];
static u32sod pu32_time_last_received[NB_MAX_SERVEURS_NTP];


/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: MiseAjour_ExploitNTP
// Entrees		: <loc_ps_config< : configuration (RAM) pour ce processus
//				: <loc_ps_exploit<: exploitation (RAM) pour ce processus
// Sortie		: <loc_u8_chgt>: TRUE si chgt des infos exploit, sinon FALSE
// Auteur		: CM - 08/07/2010 -
// Description	: Mise à jour exploitation NTP
//=====================================================================================
u8sod MiseAjour_ExploitNTP(S_STRUCT_CONFIGURATION *loc_ps_config, S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	u8sod	loc_u8_chgt;
	u8sod	loc_u8_i;
	u8sod	loc_pu8_presence_serveur_ntp[NB_MAX_SERVEURS_NTP];

	loc_u8_chgt = FALSE; //INIT
	for(loc_u8_i=0;loc_u8_i<NB_MAX_SERVEURS_NTP;loc_u8_i++)
	{
		loc_pu8_presence_serveur_ntp[loc_u8_i] = loc_ps_exploit->s_general.pu8_presence_serveur_ntp[loc_u8_i];
	}

	//Test présence serveur NTP (principal)
	AnalysePresenceServeurNTP(loc_ps_config,loc_ps_exploit, SERVEUR_NTP_PRINCIPAL);

	//Test présence serveur NTP (secours)
	if(ADRESSE_IP_NULLE != loc_ps_config->s_admin.s_client_ntp.pu32_adresse_serveur[SERVEUR_NTP_SECOURS])
	{
		AnalysePresenceServeurNTP(loc_ps_config,loc_ps_exploit, SERVEUR_NTP_SECOURS);
	}
	
	for(loc_u8_i=0;loc_u8_i<NB_MAX_SERVEURS_NTP;loc_u8_i++)
	{
		if(loc_pu8_presence_serveur_ntp[loc_u8_i] != loc_ps_exploit->s_general.pu8_presence_serveur_ntp[loc_u8_i])
		{
			loc_u8_chgt = TRUE;
		}
	}

	return loc_u8_chgt;
}/*MiseAjour_ExploitNTP*/

//=====================================================================================
// Fonction		: AnalysePresenceServeurNTP
// Entrees		: <loc_ps_config< : configuration (RAM) pour ce processus
//				: <loc_ps_exploit<: exploitation (RAM) pour ce processus
//				: <loc_u8_idx_server<: index du serveur NTP
// Sortie		: rien
// Auteur		: CM - 08/07/2010 -
// Description	: Analyse présence serveur NTP
//=====================================================================================
void AnalysePresenceServeurNTP(S_STRUCT_CONFIGURATION *loc_ps_config, S_STRUCT_EXPLOITATION *loc_ps_exploit, u8sod loc_u8_idx_server)
{
	FILE *	loc_pf_file;
	s8sod	*loc_ps8_result_fgets;
	s8sod	loc_ps8_ligne_fichier[TAILLE_MAX_LIGNE_EXP_NTP+1];
	s32sod	loc_s32_sscanf;
	u32sod	loc_u32_valeur;
	u8sod	loc_u8_etat_fichier_ntp_presence;
	u32sod	loc_u8_cpt_line;

	loc_pf_file = NULL;	//INIT
	loc_ps8_result_fgets = NULL;	//INIT
	strcpy(loc_ps8_ligne_fichier,""); //INIT
	loc_s32_sscanf = 0; //INIT
	loc_u32_valeur = 0;	//INIT
	loc_u8_etat_fichier_ntp_presence = TRUE; //INIT
	loc_u8_cpt_line = 0;	//INIT


	if(loc_u8_idx_server < NB_MAX_SERVEURS_NTP)
	{
		CmdSystem_Generique("ntpdc -c \"pstats %s\" | grep -E '(time last received|time until next send)'  > %s",
							ps8GetStringIp(loc_ps_config->s_admin.s_client_ntp.pu32_adresse_serveur[loc_u8_idx_server]),
							FICHIER_NTP_PRESENCE);
		
		if(NULL == (loc_pf_file = fopen(FICHIER_NTP_PRESENCE, "rt")))
		{
			printf("AnalysePresenceServeurNTP: Erreur creation fichier %s\n",FICHIER_NTP_PRESENCE);
			loc_u8_etat_fichier_ntp_presence = FALSE; //erreur lecture
		}
		else
		{
			loc_u8_cpt_line = 0; //RAZ
			do{
				strcpy(loc_ps8_ligne_fichier, "");	//RAZ
				//lecture de la ligne du fichier
				loc_ps8_result_fgets = fgets(loc_ps8_ligne_fichier, TAILLE_MAX_LIGNE_EXP_NTP, loc_pf_file);
				if (NULL != loc_ps8_result_fgets)
				{
					if(strstr(loc_ps8_ligne_fichier, "time last received")!=NULL) //CONDITION : chaine trouvée!!
					{
						loc_s32_sscanf = sscanf(loc_ps8_ligne_fichier, "time last received:   %lus",
												&loc_u32_valeur);

						if(1 == loc_s32_sscanf)
						{
							pu32_time_last_received[loc_u8_idx_server] = loc_u32_valeur;
						}
						else
						{
							printf("AnalysePresenceServeurNTP: Erreur ligne [1] fichier %s\n",FICHIER_NTP_PRESENCE);
							loc_u8_cpt_line = NB_MAX_LIGNES_FICHIER_NTP_PRESENCE+1; //on sort
						}
					}
					else
					{
						if(strstr(loc_ps8_ligne_fichier, "time until next send")!=NULL) //CONDITION : chaine trouvée!!
						{
							loc_s32_sscanf = sscanf(loc_ps8_ligne_fichier, "time until next send:   %lus",
								&loc_u32_valeur);

							if(1 == loc_s32_sscanf)
							{
							//on capture le temps avant de la prochaine émission de la requete
								if(TIME_UNTIL_NEXT_SEND_DISABLED == pu32_time_until_next_send[loc_u8_idx_server]) //CONDITION: si on n'a pas enregistré de valeur du temps avant prochaine requete
								{
								// pas de temps avant prochaine émission encore enregistré
									pu32_time_until_next_send[loc_u8_idx_server] = TIME_UNTIL_NEXT_SEND_DEFAULT;
								}
								else
								{
								// si réponse reçue il y a pas trop longtemps
									if(pu32_time_last_received[loc_u8_idx_server] < TIME_LAST_RECEIVED_EARLY)
									{
										pu32_time_until_next_send[loc_u8_idx_server] = (loc_u32_valeur+pu32_time_last_received[loc_u8_idx_server]);
									}
								}
							}
							else
							{
								printf("AnalysePresenceServeurNTP: Erreur ligne [1] fichier %s\n",FICHIER_NTP_PRESENCE);
								loc_u8_etat_fichier_ntp_presence = FALSE; //erreur lecture
							}
						}
						else
						{
							printf("AnalysePresenceServeurNTP: Erreur ligne [2] fichier %s\n",FICHIER_NTP_PRESENCE);
							loc_u8_etat_fichier_ntp_presence = FALSE; //erreur lecture
						}
					}
				}
				else //CONDITION: erreur lecture
				{
					loc_u8_etat_fichier_ntp_presence = FALSE; //erreur lecture
				}
				loc_u8_cpt_line++;
			}while((loc_u8_cpt_line < NB_MAX_LIGNES_FICHIER_NTP_PRESENCE)&&
				   (TRUE == loc_u8_etat_fichier_ntp_presence));

			//fermeture du fichier
			fclose(loc_pf_file);

			if(TRUE == loc_u8_etat_fichier_ntp_presence) //CONDITION: lecture fichier OK
			{
//				printf("AnalysePresenceServeurNTP: time_last_received=%lu time_until_next_send=%lu\n",pu32_time_last_received[loc_u8_idx_server], pu32_time_until_next_send[loc_u8_idx_server]);
				if(pu32_time_last_received[loc_u8_idx_server] < (pu32_time_until_next_send[loc_u8_idx_server]+OFFSET_DETECTION_DEFAUT_PRESENCE_NTP)) //CONDITION: requete NTP reçue avant timeout
				{
					loc_ps_exploit->s_general.pu8_presence_serveur_ntp[loc_u8_idx_server] = TRUE; //serveur NTP présent
				}
				else
				{
					loc_ps_exploit->s_general.pu8_presence_serveur_ntp[loc_u8_idx_server] = FALSE; //serveur NTP absent
				}
			}
		}
	}

}/*AnalysePresenceServeurNTP*/

//=====================================================================================
// Fonction		: Raz_Exp_Npt
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 10/12/2010 -
// Description	: Raz exploitation NTP
//=====================================================================================
void Raz_Exp_Ntp(void)
{
	u8sod	loc_u8_i;
	for(loc_u8_i=0;loc_u8_i<NB_MAX_SERVEURS_NTP;loc_u8_i++)
	{
		pu32_time_until_next_send[loc_u8_i] = TIME_UNTIL_NEXT_SEND_DISABLED; //RAZ
		pu32_time_last_received[loc_u8_i] = TIME_LAST_RECEIVED_DISABLED; //RAZ
	}

}/*Raz_Exp_Ntp*/

/*_____VII - PROCEDURE D'INITIALISATION __________________________________*/

//=====================================================================================
// Fonction		: InitModule_Exp_Ntp
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 08/07/2010 -
// Description	: Initialisation du module de exp_ntp
//=====================================================================================
void InitModule_Exp_Ntp(void)
{
	u8sod	loc_u8_i;
	for(loc_u8_i=0;loc_u8_i<NB_MAX_SERVEURS_NTP;loc_u8_i++)
	{
		pu32_time_until_next_send[loc_u8_i] = TIME_UNTIL_NEXT_SEND_DISABLED; //INIT
		pu32_time_last_received[loc_u8_i] = TIME_LAST_RECEIVED_DISABLED; //INIT
	}
	
}/*InitModule_Exp_Ntp*/

