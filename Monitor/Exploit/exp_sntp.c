/*========================================================================*/
/* NOM DU FICHIER  : exp_sntp.c	 		                                  */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 09/12/2010                                           */
/* Libelle         : Monitor: exploitation du client SNTP				  */
/* Projet          : WRM100                                               */
/* Indice          : BE050                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE050 09/12/2010 CM
// - CREATION
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/
#define _EXP_SNTP


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../headers.h"

#define NB_MAX_LIGNES_FICHIER_EXP_SNTP	2
#define TAILLE_MAX_LIGNE_EXP_SNTP	500

/*_____IV - VARIABLES GLOBALES ___________________________________________*/


/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: MiseAjour_ExploitSNTP
// Entrees		: <loc_ps_config< : configuration (RAM) pour ce processus
//				: <loc_ps_exploit<: exploitation (RAM) pour ce processus
// Sortie		: <loc_u8_chgt>: TRUE si chgt des infos exploit, sinon FALSE
// Auteur		: CM - 09/12/2010 -
// Description	: Mise à jour exploitation SNTP
//=====================================================================================
u8sod MiseAjour_ExploitSNTP(S_STRUCT_CONFIGURATION *loc_ps_config, S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	u8sod	loc_u8_chgt;
	FILE *	loc_pf_file;
	s8sod	*loc_ps8_result_fgets;
	s8sod	loc_ps8_ligne_fichier[TAILLE_MAX_LIGNE_EXP_SNTP+1];
	u8sod	loc_u8_i;
	u8sod	loc_pu8_presence_serveur_ntp[NB_MAX_SERVEURS_NTP];
	u8sod	loc_u8_etat_fichier;
	u32sod	loc_u8_cpt_line;

	loc_u8_chgt = FALSE; //INIT
	loc_pf_file = NULL;	//INIT
	loc_ps8_result_fgets = NULL;	//INIT
	strcpy(loc_ps8_ligne_fichier,""); //INIT
	for(loc_u8_i=0;loc_u8_i<NB_MAX_SERVEURS_NTP;loc_u8_i++)
	{
		loc_pu8_presence_serveur_ntp[loc_u8_i] = loc_ps_exploit->s_general.pu8_presence_serveur_ntp[loc_u8_i];
	}
	loc_u8_etat_fichier = TRUE; //INIT
	loc_u8_cpt_line = 0;	//INIT
	
	if(NULL == (loc_pf_file = fopen(FICHIER_SNTP_INFO, "rt")))
	{
		printf("MiseAjour_ExploitSNTP: Erreur lecture fichier %s\n",FICHIER_SNTP_INFO);
		loc_u8_etat_fichier = FALSE; //erreur lecture
	}
	else
	{
		loc_u8_cpt_line = 0; //RAZ
		loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_PRINCIPAL] = TRUE; //RAZ
		if(ADRESSE_IP_NULLE == loc_ps_config->s_admin.s_client_ntp.pu32_adresse_serveur[SERVEUR_NTP_SECOURS])
		{
			loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_SECOURS] = FALSE; //RAZ
		}
		else
		{
			loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_SECOURS] = TRUE; //RAZ
		}
		do{
			strcpy(loc_ps8_ligne_fichier, "");	//RAZ
			//lecture de la ligne du fichier
			loc_ps8_result_fgets = fgets(loc_ps8_ligne_fichier, TAILLE_MAX_LIGNE_EXP_SNTP, loc_pf_file);
			if (NULL != loc_ps8_result_fgets)
			{
				if(strstr(loc_ps8_ligne_fichier, ps8GetStringIp(loc_ps_config->s_admin.s_client_ntp.pu32_adresse_serveur[SERVEUR_NTP_PRINCIPAL]))!=NULL) //CONDITION : chaine trouvée!!
				{
					if(strstr(loc_ps8_ligne_fichier, "dropped")!=NULL) //CONDITION : chaine trouvée!!
					{
						loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_PRINCIPAL] = FALSE; //serveur NTP absent
					}
				}
				else
				{
					if(strstr(loc_ps8_ligne_fichier, ps8GetStringIp(loc_ps_config->s_admin.s_client_ntp.pu32_adresse_serveur[SERVEUR_NTP_SECOURS]))!=NULL) //CONDITION : chaine trouvée!!
					{
						if(ADRESSE_IP_NULLE != loc_ps_config->s_admin.s_client_ntp.pu32_adresse_serveur[SERVEUR_NTP_SECOURS])
						{
							if(strstr(loc_ps8_ligne_fichier, "dropped")!=NULL) //CONDITION : chaine trouvée!!
							{
								loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_SECOURS] = FALSE; //serveur NTP absent
							}
						}
						else
						{
							loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_SECOURS] = FALSE; //serveur NTP absent
						}
					}
				}
			}
			else //CONDITION: erreur lecture
			{
				loc_u8_etat_fichier = FALSE; //erreur lecture
			}
			loc_u8_cpt_line++;
		}while((loc_u8_cpt_line < NB_MAX_LIGNES_FICHIER_EXP_SNTP)&&
			   (TRUE == loc_u8_etat_fichier));

		//fermeture du fichier
		fclose(loc_pf_file);
	}
	
	
	for(loc_u8_i=0;loc_u8_i<NB_MAX_SERVEURS_NTP;loc_u8_i++)
	{
		if(loc_pu8_presence_serveur_ntp[loc_u8_i] != loc_ps_exploit->s_general.pu8_presence_serveur_ntp[loc_u8_i])
		{
			loc_u8_chgt = TRUE;
		}
	}

	return loc_u8_chgt;
}/*MiseAjour_ExploitSNTP*/

/*_____VII - PROCEDURE D'INITIALISATION __________________________________*/

//=====================================================================================
// Fonction		: InitModule_Exp_Sntp
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 09/12/2010 -
// Description	: Initialisation du module de exp_sntp
//=====================================================================================
void InitModule_Exp_Sntp(void)
{
	
}/*InitModule_Exp_Sntp*/

