/*========================================================================*/
/* NOM DU FICHIER  : exp_versions.c	 		                              */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 26/01/2010                                           */
/* Libelle         : Monitor: exploitation versions						  */
/* Projet          : WRM100                                               */
/* Indice          : BE014                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE007 26/01/2010 CM
// - CREATION
//BE014 08/03/2010 CM
// - Modification gestion de l'exploitation
//	=> toute l'exploitation est calculée dans le processus 'monitor'.
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/
#define _EXP_VERSIONS


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../headers.h"

/*_____IV - VARIABLES GLOBALES ___________________________________________*/


/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: MiseAjour_Versions
// Entrees		: <loc_ps_exploit<: exploitation (RAM) pour ce processus
// Sortie		: rien
// Auteur		: CM - 24/09/2009 -
// Description	: Mise à jour des versions logicielles
//=====================================================================================
void MiseAjour_Versions(S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	FILE	*loc_p_handle;
	s32sod	loc_s32_caracter;
	s8sod	*loc_ps8_result_fgets;
	s8sod	loc_ps8_ligne_fichier[TAILLE_MAX_VALEUR_INFOSYSVERSION+1];
	s8sod	loc_ps8_msg_version[TAILLE_MAX_MSG_VERSION+1];
	s32sod	loc_s32_sscanf;

	loc_p_handle = NULL; //INIT
	loc_ps8_result_fgets = NULL;	//INIT
	strcpy(loc_ps8_ligne_fichier,""); //INIT
	strcpy(loc_ps8_msg_version,""); //INIT
	loc_s32_sscanf = 0; //INIT

	if(TRUE == u8FillExploitGeneralFile(&loc_ps_exploit->s_general))
	{
		//Détermination programme activé de la version CPU
		if(NULL != (loc_p_handle = fopen( FILE_MODEBOOT_INIT, "rt" ))) //CONDITION: fichier présent
		{
			//lecture du caractère
			loc_s32_caracter = fgetc(loc_p_handle);
			switch(loc_s32_caracter)
			{
				case '1': //APP1
					loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_APPLI_CPU].u8_info_suppl = INFO_VERSION_PROG_NUMERO_1;
					break;
				case '2': //APP2
					loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_APPLI_CPU].u8_info_suppl = INFO_VERSION_PROG_NUMERO_2;
					break;
				default:
					loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_APPLI_CPU].u8_info_suppl = INFO_VERSION_PROG_INACTIF;
					break;
			}

			//fermeture du fichier
			fclose (loc_p_handle);
		}
		else
		{
			loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_APPLI_CPU].u8_info_suppl = INFO_VERSION_PROG_INACTIF;
		}

		//Détermination programme activé de la version du bootloader
		if(NULL != (loc_p_handle = fopen( FILE_UBOOT_INIT, "rt" ))) //CONDITION: fichier présent
		{
			loc_ps8_result_fgets = fgets(loc_ps8_ligne_fichier, TAILLE_MAX_VALEUR_INFOSYSVERSION, loc_p_handle);
			if (NULL != loc_ps8_result_fgets)
			{
				printf("MiseAjour_Versions: bootloader=%s\n",loc_ps8_ligne_fichier);
				//Version au format "U-Boot 1.2.<versionOfficielle>.<versionBe>"
				loc_s32_sscanf = sscanf(loc_ps8_ligne_fichier, "U-Boot 1.2.%[^.].%*s",
										loc_ps8_msg_version);

				if(1 == loc_s32_sscanf)
				{
					strcpy(loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_BOOT_CPU].ps8_message, loc_ps8_msg_version);
				}
				else
				{
					strcpy(loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_BOOT_CPU].ps8_message, "?");
				}
				printf("MiseAjour_Versions:VERSION_LOGICIELLE_BOOT_CPU=%s\n",loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_BOOT_CPU].ps8_message);

				if(strlen(loc_ps8_ligne_fichier) < TAILLE_MAX_MSG_VERSION_UBOOT)
				{
					strcpy(loc_ps_exploit->s_general.ps8_version_be_uboot, loc_ps8_ligne_fichier);
				}
			}
			else
			{
				strcpy(loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_BOOT_CPU].ps8_message, "?"); 
			}

			//fermeture du fichier
			fclose (loc_p_handle);
		}
		else
		{
			loc_ps_exploit->s_general.s_version[VERSION_LOGICIELLE_APPLI_CPU].u8_info_suppl = INFO_VERSION_PROG_INACTIF;
		}

		//Puis sauvegarde
		u8EditExploitGeneralFile(&loc_ps_exploit->s_general);
	}

}/*MiseAjour_Versions*/



/*_____VII - PROCEDURE D'INITIALISATION __________________________________*/

//=====================================================================================
// Fonction		: InitModule_Exp_Versions
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 26/01/2010 -
// Description	: Initialisation du module de exp_versions
//=====================================================================================
void InitModule_Exp_Versions(void)
{
	
}/*InitModule_Exp_Versions*/

