/*========================================================================*/
/* NOM DU FICHIER  : exp_wifi_station.c	                                  */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 18/01/2010                                           */
/* Libelle         : Monitor: exploitation du wifi de la STATION		  */
/* Projet          : WRM100                                               */
/* Indice          : BE058                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE005 15/01/2010 CM
// - CREATION
//BE013 26/02/2010 CM
// - Modification chemins des bdd (sous /tmp)
//BE014 08/03/2010 CM
// - Modification gestion de l'exploitation
//	=> toute l'exploitation est calculée dans le processus 'monitor'.
//BE031.3 08/06/2010 JP
// - dans la page test production final, l'etat de la connexion de la station est memorise avec code couleur (rouge, orange,vert)
//BE047 29/11/2010 CM
// - Gestion mode dégradé - connection à AP impossible en permanence suite à configuration wifi 
//BE051 13/12/2010 CM
// - Ajout exploitation SSID (utile si dual ssid activé)
//BE058 21/01/2011 CM
// - Ajout dans exploitation du canal en cours (sur AP et STA)
// - Modification gestion exploitation wifi
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/
#define _EXP_WIFI_STATION

//Exploitation Wifi STATION
#define FICHIER_WPA_STATUS_STATION	PATH_DIR__BDD_EXPLOIT	"wpa_status"
#define TAILLE_MAX_LIGNE_FICHIER_WPA_STATUS	100

/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../headers.h"


/*_____IV - VARIABLES GLOBALES ___________________________________________*/


/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: u8ExtractExploitWpaStatus
// Entrees		: <loc_ps_exploit<: exploitation (RAM) pour ce processus
//				: <loc_pu8_wpa_state< : etat wpa
// Sortie		: <loc_u8_resultat>: extraction OK (TRUE), sinon FALSE
// Auteur		: CM - 01/12/2010 -
// Description	: extraction status wpa exploitation Wifi (station)
//=====================================================================================
u8sod u8ExtractExploitWpaStatus(S_STRUCT_EXPLOITATION *loc_ps_exploit, u8sod *loc_pu8_wpa_state)
{
	u8sod loc_u8_resultat;
	FILE *	loc_pf_file;
	s8sod	*loc_ps8_result_fgets;
	s8sod	loc_ps8_ligne_fichier[TAILLE_MAX_LIGNE_FICHIER_WPA_STATUS+1];
	s32sod	loc_s32_sscanf;
	u32sod	loc_u32_valeur;

	loc_u8_resultat = TRUE;	//INIT
	loc_ps8_result_fgets = NULL;	//INIT
	strcpy(loc_ps8_ligne_fichier,""); //INIT
	loc_s32_sscanf = 0; //INIT
	loc_u32_valeur = 0;	//INIT

#ifdef _WRM100_ABG_SELECT
	CmdSystem_Generique("wpa_cli status | grep wpa_state > %s",
						FICHIER_WPA_STATUS_STATION);
#endif

#ifdef _WRM100_N_SELECT
	CmdSystem_Generique("wpa_cli status | grep -E 'wpa_state|cptsecond_noconnected' > %s",
						FICHIER_WPA_STATUS_STATION);
#endif

	*loc_pu8_wpa_state = FALSE; //RAZ
	loc_ps_exploit->s_station.u32_cptsecond_noconnected = 0; //RAZ

	if(NULL == (loc_pf_file = fopen(FICHIER_WPA_STATUS_STATION, "rt")))
	{
		loc_u8_resultat = FALSE; //lecture KO
		printf("u8TestStation_ConnecteeModeWPA: Erreur creation fichier %s\n",FICHIER_WPA_STATUS_STATION);
	}
	else
	{
		//Premiere ligne
		strcpy(loc_ps8_ligne_fichier, "");	//RAZ
		//lecture de la ligne du fichier
		loc_ps8_result_fgets = fgets(loc_ps8_ligne_fichier, TAILLE_MAX_LIGNE_FICHIER_WPA_STATUS, loc_pf_file);
		if (NULL != loc_ps8_result_fgets)
		{
			if(strstr(loc_ps8_ligne_fichier, "wpa_state")!=NULL) //CONDITION : chaine trouvée!!
			{
				if(strstr(loc_ps8_ligne_fichier, "COMPLETED")!=NULL) //CONDITION : chaine trouvée!!
				{
					*loc_pu8_wpa_state = TRUE; //CONNECTE
				}
			}
			else
			{
				loc_u8_resultat = FALSE; //lecture KO
			}
		}
		else
		{
			loc_u8_resultat = FALSE; //lecture KO
		}
		
#ifdef _WRM100_N_SELECT
		//Seconde ligne
		strcpy(loc_ps8_ligne_fichier, "");	//RAZ
		//lecture de la ligne du fichier
		loc_ps8_result_fgets = fgets(loc_ps8_ligne_fichier, TAILLE_MAX_LIGNE_FICHIER_WPA_STATUS, loc_pf_file);
		if (NULL != loc_ps8_result_fgets)
		{
			if(strstr(loc_ps8_ligne_fichier, "cptsecond_noconnected")!=NULL) //CONDITION : chaine trouvée!!
			{
				loc_s32_sscanf = sscanf(loc_ps8_ligne_fichier, "cptsecond_noconnected=%lu",
										&loc_u32_valeur);
//				printf("u8TestStation_ConnecteeModeWPA: loc_s32_sscanf=%lu => %lu\n",loc_s32_sscanf,loc_u32_valeur);
				if(1 == loc_s32_sscanf) //CONDITION: lecture OK
				{
					loc_ps_exploit->s_station.u32_cptsecond_noconnected = loc_u32_valeur;
				}
				else
				{
					loc_u8_resultat = FALSE; //lecture KO
					printf("u8TestStation_ConnecteeModeWPA: Erreur1 ligne [2] fichier %s\n",FICHIER_WPA_STATUS_STATION);
				}
			}
			else
			{
				loc_u8_resultat = FALSE; //lecture KO
				printf("u8TestStation_ConnecteeModeWPA: Erreur2 ligne [2] fichier %s\n",FICHIER_WPA_STATUS_STATION);
			}
		}
		else
		{
			loc_u8_resultat = FALSE; //lecture KO
			printf("u8TestStation_ConnecteeModeWPA: Erreur3 ligne [2] fichier %s\n",FICHIER_WPA_STATUS_STATION);
		}
#endif

		//fermeture du fichier
		fclose(loc_pf_file);
	}
	return loc_u8_resultat;
}/*u8ExtractExploitWpaStatus*/


//=====================================================================================
// Fonction		: ExtractExploitWifiStation
// Entrees		: <loc_ps_config< : configuration (RAM) pour ce processus
//				: <loc_ps_exploit<: exploitation (RAM) pour ce processus
// Sortie		: rien
// Auteur		: CM - 24/09/2009 -
// Description	: extraction exploitation Wifi (station)
//=====================================================================================
void ExtractExploitWifiStation(S_STRUCT_CONFIGURATION *loc_ps_config, S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	s32sod loc_s32_valeur;
	u8sod	loc_u8_wpa_state;

	loc_s32_valeur = 0;	//INIT
	loc_u8_wpa_state = FALSE;	//non connecté

	if(TRUE == u8FillExploitStationFile(&loc_ps_exploit->s_station))
	{
		//Extraction BSSID
		//Modif by VuHai
		/*if(TRUE == u8GetWifiBSSID_Ioctl(&loc_ps_exploit->s_station))
		{
			switch(loc_ps_config->s_wifi.u8_mode_securite_wifi)
			{
				case MODE_SECURITE_WIFI_AUCUN:
					loc_ps_exploit->s_station.u32_cptsecond_noconnected = 0; //RAZ
					break;
				case MODE_SECURITE_WIFI_WEP:
					loc_ps_exploit->s_station.u32_cptsecond_noconnected = 0; //RAZ
					break;
				default: //WPA
					if(TRUE == u8ExtractExploitWpaStatus(loc_ps_exploit, &loc_u8_wpa_state)) //CONDITION: lecture OK
					{
						if(STATUT_CONNEXION__ASSOCIATED == loc_ps_exploit->s_station.u8_statut_connexion) //CONDITION: pour le Driver, station associée
						{
							if(FALSE == loc_u8_wpa_state) //CONDITION: STATION non connectée (pour le wpa_supplicant)
							{
								//on force en mode non associé
								loc_ps_exploit->s_station.u8_statut_connexion = STATUT_CONNEXION__NOT_ASSOCIATED;
								loc_ps_exploit->s_station.u8_old_statut_connexion = STATUT_CONNEXION__NOT_ASSOCIATED;
							}
						}
						else //CONDITION: pour le Driver, station non associée
						{
							//on force en mode non associé
							loc_ps_exploit->s_station.u8_statut_connexion = STATUT_CONNEXION__NOT_ASSOCIATED;
							loc_ps_exploit->s_station.u8_old_statut_connexion = STATUT_CONNEXION__NOT_ASSOCIATED;
						}
					}
					break;
			}
		}*/

		if(STATUT_CONNEXION__ASSOCIATED == loc_ps_exploit->s_station.u8_statut_connexion)  //CONDITION: connectée
		{
			if(TRUE != u8_debug_madwifi_on)  //CONDITION: debug non activé
			{
				//Extraction RSSI moyenné
#ifdef _WRM100_ABG_SELECT
				if(TRUE == u8WlanABG_GetWifiRSSIFilter_Ioctl(&loc_s32_valeur))
				{
					//On met à jour l'information RSSI (uniquement si valeur retournée par IOCTL est non nulle)
					//car de temps en temps, la fonction Ioctl retourne une valeur nulle!
					if(0 != loc_s32_valeur) //CONDITION: valeur RSSI non nulle
					{
						loc_ps_exploit->s_station.s32_rssi_dbm = s32ConvertRssiToDBm(loc_s32_valeur);
					}
				}
#endif
#ifdef _WRM100_N_SELECT
				if(0 != t_driverWifiN_userinfo.u8_rssi_filter) //CONDITION: valeur RSSI non nulle
				{
					loc_ps_exploit->s_station.s32_rssi_dbm = s32ConvertRssiToDBm((s32sod)t_driverWifiN_userinfo.u8_rssi_filter);
				}
#endif

				//Extraction ESSID (nom)
				if(TRUE == u8GetWifiESSID_Ioctl(&loc_ps_exploit->s_station))
				{
					;
				}
			}
			else //CONDITION: debug activé
			{
				loc_ps_exploit->s_station.s32_rssi_dbm = VALEUR_RSSI_MIN;
			}

#ifdef _WRM100_N_SELECT
			//Canal en cours
			loc_ps_exploit->s_station.u16_channel_inprogress = (u16sod)t_driverWifiN_userinfo.u8_ieee_inprogress;
			loc_ps_exploit->s_station.u16_freq_MHz_inprogress = t_driverWifiN_userinfo.u16_freq_MHz_inprogress;
#endif
		}
		else //CONDITION: non connectée
		{
			loc_ps_exploit->s_station.s32_rssi_dbm = VALEUR_RSSI_MIN;	//RAZ
			strcpy(loc_ps_exploit->s_station.ps8_ssid_inprogress, "");	//RAZ
#ifdef _WRM100_N_SELECT
			//Canal en cours
			loc_ps_exploit->s_station.u16_channel_inprogress = CHANNEL_RADIO_DISABLED;
			loc_ps_exploit->s_station.u16_freq_MHz_inprogress = 0;
#endif
		}
		
		u8EditExploitStationFile(&loc_ps_exploit->s_station);
	}

}/*ExtractExploitWifiStation*/



/*_____VII - PROCEDURE D'INITIALISATION __________________________________*/

//=====================================================================================
// Fonction		: InitModule_Exp_Wifi_Station
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 18/01/2010 -
// Description	: Initialisation du module de exp_wifi_station
//=====================================================================================
void InitModule_Exp_Wifi_Station(void)
{
	
}/*InitModule_Exp_Wifi_Station*/

