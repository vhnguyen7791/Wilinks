/*========================================================================*/
/* NOM DU FICHIER  : exp_wlan_ABG.c	 		                              */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 14/09/2010                                           */
/* Libelle         : Monitor: exploitation de la carte wifi ABG			  */
/* Projet          : WRM100                                               */
/* Indice          : BE040                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE010 14/09/2010 CM
// - CREATION
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/
#define _EXP_WLAN_ABG


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../headers.h"

//Définition des fichiers sous /proc/net/madwifi/wifi0/associated_sta
#define PATH_DIR__NET_MADWIFI_WIFI0 PATH_DIR_PROC "net/madwifi/ath0/"
#define TAILLE_MAX_LIGNE_PROCNETASSOCIATEDSTA		300
#define FICHIER__NET_MADWIFI_ASSOCIATED_STA	PATH_DIR__NET_MADWIFI_WIFI0	"associated_sta"

/*_____IV - VARIABLES GLOBALES ___________________________________________*/


/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: WlanABG_MiseAJour_TableClientsWifi
// Entrees		: <loc_ps_exp_accesspoint<: exploitation (RAM) pour ce processus
// Sortie		: rien
// Auteur		: CM - 14/09/2010 -
// Description	: Mise à jour des clients Wifi de l'Access Point
//=====================================================================================
void WlanABG_MiseAJour_TableClientsWifi(S_STRUC_EXP_ACCESS_POINT *loc_ps_exp_accesspoint)
{
	u8sod	loc_u8_resultat;
	FILE	*loc_p_handle;
	s8sod	*loc_ps8_result_fgets;
	s8sod	loc_ps8_ligne[TAILLE_MAX_LIGNE_PROCNETASSOCIATEDSTA+1];
	u16sod	loc_u16_cpt;
	s32sod	loc_s32_sscanf;
	S_STRUCT_EXP_WIFI_CLIENT loc_s_wifi_client;
	u8sod loc_u8_i;
	u32sod	loc_pu32_addr_mac[ETHER_ADDR_LEN];
	s32sod	loc_s32_valeur;
	u16sod loc_u16_nb_client;

	loc_u8_resultat = TRUE; //INIT
	loc_p_handle = NULL; //INIT
	loc_ps8_result_fgets = NULL; //INIT
	strcpy(loc_ps8_ligne, ""); //INIT
	loc_u16_cpt = 0;	//INIT
	loc_s32_sscanf = 0; //INIT
	memset(&loc_s_wifi_client, 0, sizeof(S_STRUCT_EXP_WIFI_CLIENT)); //INIT
	for(loc_u8_i=0;loc_u8_i<ETHER_ADDR_LEN;loc_u8_i++)
	{
		loc_pu32_addr_mac[loc_u8_i] = 0;	//INIT
	}
	loc_s32_valeur = 0;	//INIT
	loc_u16_nb_client = 0; //INIT

	//On récupère la liste des clients Wifi (détectés par l'access point)
	if(NULL == (loc_p_handle = fopen( FICHIER__NET_MADWIFI_ASSOCIATED_STA, "rt" )))
	{
		printf("WlanABG_MiseAJour_TableClientsWifi: Impossible de lire fichier %s\n",FICHIER__NET_MADWIFI_ASSOCIATED_STA);
		loc_u8_resultat = FALSE; //on sort
	}
	else
	{
		//Lecture du fichier / extraction des informations
		
		do{
			loc_ps8_result_fgets = fgets(loc_ps8_ligne,TAILLE_MAX_LIGNE_PROCNETASSOCIATEDSTA,loc_p_handle);
			if(NULL != loc_ps8_result_fgets) //CONDITION: ligne lue
			{
				//Recherche ligne avec 'macaddr'
				if(NULL != strstr(loc_ps8_ligne, "macaddr")) //CONDITION: ligne avec 'macaddr'
				{
					memset(&loc_s_wifi_client, 0, sizeof(S_STRUCT_EXP_WIFI_CLIENT)); //RAZ
					//On lit l'adresse MAC
					loc_s32_sscanf = sscanf(loc_ps8_ligne, "%*[^<]<%02lX:%02lX:%02lX:%02lX:%02lX:%02lX>%*s",
											&loc_pu32_addr_mac[0], &loc_pu32_addr_mac[1],
											&loc_pu32_addr_mac[2], &loc_pu32_addr_mac[3],
											&loc_pu32_addr_mac[4], &loc_pu32_addr_mac[5]);
					if(ETHER_ADDR_LEN != loc_s32_sscanf)//CONDITION: lecture KO
					{
						loc_u8_resultat = FALSE; //on sort
					}
					else
					{
						for(loc_u8_i=0;loc_u8_i<ETHER_ADDR_LEN;loc_u8_i++)
						{
							loc_s_wifi_client.pu8_add_mac[loc_u8_i] = (u8sod)loc_pu32_addr_mac[loc_u8_i];
						}
						loc_s_wifi_client.u8_present = TRUE; 
					}
				}
				else
				{
					if(TRUE != u8_debug_madwifi_on)  //CONDITION: debug non activé
					{
						if(NULL != strstr(loc_ps8_ligne, "RSSI")) //CONDITION: ligne avec 'RSSI'
						{
							//On lit la mesure RSSI
							loc_s32_sscanf = sscanf(loc_ps8_ligne, " RSSI %ld",	(s32sod*)&loc_s32_valeur);
							if(1 != loc_s32_sscanf)//CONDITION: lecture KO
							{
								loc_u8_resultat = FALSE; //on sort
							}
							else
							{
								loc_s_wifi_client.s32_rssi_dbm = s32ConvertRssiToDBm(loc_s32_valeur);
							}
						}
						else
						{
							if(NULL != strstr(loc_ps8_ligne, "ni_tstamp")) //CONDITION: dernière ligne
							{
								if(TRUE == loc_s_wifi_client.u8_present)
								{
//									printf("WlanABG_MiseAJour_TableClientsWifi: u8MajDonneesClientWifi %s\n",ps8GetChAddressMac(loc_s_wifi_client.pu8_add_mac));
									loc_s_wifi_client.u8_flag_maj = TRUE;
									loc_s_wifi_client.u32_statut |= (u32sod)(1<<BIT1_STA_CLIENTWIFI_ASSOCIATED);
									if(FALSE == u8MajDonneesClientWifi(loc_ps_exp_accesspoint, &loc_s_wifi_client))
									{
										printf("WlanABG_MiseAJour_TableClientsWifi: u8MajDonneesClientWifi KO\n");
									}
									else
									{
										loc_u16_nb_client ++;
									}
								}
								memset(&loc_s_wifi_client, 0, sizeof(S_STRUCT_EXP_WIFI_CLIENT)); //RAZ
							}
						}
					}
					else //CONDITION: madwifi activé
					{
//d: -------------------------------- DEBUG -------------------------------------------------------						
						if(NULL != strstr(loc_ps8_ligne, "rssi")) //CONDITION: ligne avec 'rssi'
						{
							//On lit la mesure RSSI
							loc_s32_sscanf = sscanf(loc_ps8_ligne, " rssi %ld",	(s32sod*)&loc_s32_valeur);
							if(1 != loc_s32_sscanf)//CONDITION: lecture KO
							{
								loc_u8_resultat = FALSE; //on sort
							}
							else
							{
								loc_s_wifi_client.s32_rssi_dbm = s32ConvertRssiToDBm(loc_s32_valeur);
							}
						}
						else
						{
							if(NULL != strstr(loc_ps8_ligne, "last_rx")) //CONDITION: dernière ligne
							{
								if(TRUE == loc_s_wifi_client.u8_present)
								{
//									printf("WlanABG_MiseAJour_TableClientsWifi: u8MajDonneesClientWifi %s\n",ps8GetChAddressMac(loc_s_wifi_client.pu8_add_mac));
									loc_s_wifi_client.u8_flag_maj = TRUE;
									loc_s_wifi_client.u32_statut |= (u32sod)(1<<BIT1_STA_CLIENTWIFI_ASSOCIATED);
									if(FALSE == u8MajDonneesClientWifi(loc_ps_exp_accesspoint, &loc_s_wifi_client))
									{
										printf("WlanABG_MiseAJour_TableClientsWifi: u8MajDonneesClientWifi KO\n");
									}
									else
									{
										loc_u16_nb_client ++;
									}
								}
								memset(&loc_s_wifi_client, 0, sizeof(S_STRUCT_EXP_WIFI_CLIENT)); //RAZ
							}
						}
					}
//f: -------------------------------- DEBUG -------------------------------------------------------						
				}
			}

			loc_u16_cpt ++;

		}while((NULL != loc_ps8_result_fgets) &&
			   (loc_u16_cpt < (NB_ASSOCIATED_STATIONS_MAX*4)) && //*4: car 4 lignes d'infos par station
			   (TRUE == loc_u8_resultat)
			  );

		//fermeture du fichier
		fclose (loc_p_handle);
	}

	//On détermine le nombre de clients wifi connectés
	loc_ps_exp_accesspoint->u16_nb_associations = loc_u16_nb_client;

}/*WlanABG_MiseAJour_TableClientsWifi*/

/*_____VII - PROCEDURE D'INITIALISATION __________________________________*/

//=====================================================================================
// Fonction		: InitModule_Exp_Wlan_ABG
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 14/09/2010 -
// Description	: Initialisation du module de exp_wlan_ABG
//=====================================================================================
void InitModule_Exp_Wlan_ABG(void)
{
	
}/*InitModule_Exp_Wlan_ABG*/

