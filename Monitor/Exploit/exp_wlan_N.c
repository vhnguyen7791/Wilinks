/*========================================================================*/
/* NOM DU FICHIER  : exp_wlan_N.c	 		                              */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 14/09/2010                                           */
/* Libelle         : Monitor: exploitation de la carte wifi N			  */
/* Projet          : WRM100                                               */
/* Indice          : BE040                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE010 14/09/2010 CM
// - CREATION
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/
#define _EXP_WLAN_N


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../headers.h"

#include "../../Include/header_driver_N.h"

/*_____IV - VARIABLES GLOBALES ___________________________________________*/

#define TAILLE_MAX_BUFFER_REQ_STA_INFO	(24*1024)
static u8sod pu8_buffer_req_sta_info[TAILLE_MAX_BUFFER_REQ_STA_INFO];

/*_____V - PROCEDURES ____________________________________________________*/

//=====================================================================================
// Fonction		: WlanN_MiseAJour_TableClientsWifi
// Entrees		: <loc_ps_exp_accesspoint<: exploitation (RAM) pour ce processus
// Sortie		: rien
// Auteur		: CM - 14/09/2010 -
// Description	: Mise à jour des clients Wifi de l'Access Point pour la carte N
//=====================================================================================
void WlanN_MiseAJour_TableClientsWifi(S_STRUC_EXP_ACCESS_POINT *loc_ps_exp_accesspoint)
{
	s32sod	loc_s32_sockfd;
	struct iwreq loc_t_req;
	u8sod	*loc_pu8_cp;
	s32sod loc_u32_len;
	u32sod loc_u32_txrate;
	struct ieee80211req_sta_info *loc_ps_sta_info;
	u8sod *loc_pu8_vp;
	S_STRUCT_EXP_WIFI_CLIENT loc_s_wifi_client;
	u8sod loc_u8_i;
	u16sod loc_u16_nb_client;
	u16sod	loc_u16_cpt;

	memset(&loc_t_req, 0, sizeof(struct iwreq)); //INIT
	loc_pu8_cp = NULL;
	loc_u32_len = 0;	//INIT
	loc_ps_sta_info = NULL;	//INIT
	loc_pu8_vp = NULL;	//INIT
	loc_u32_txrate = 0;	//INIT
	memset(&loc_s_wifi_client, 0, sizeof(S_STRUCT_EXP_WIFI_CLIENT)); //INIT
	loc_u16_nb_client = 0; //INIT
	loc_u16_cpt = 0;	//INIT
	
	if((loc_s32_sockfd = socket(AF_INET, SOCK_DGRAM, 0)) < 0)
	{
		perror("?????: Could not create simple datagram socket \n");
	}
	else
	{
		sprintf(loc_t_req.ifr_name, NOM_INTERFACE_WIFI);
		loc_t_req.u.data.pointer = (void *)pu8_buffer_req_sta_info;
		loc_t_req.u.data.length = sizeof(pu8_buffer_req_sta_info);
		/*if(ioctl(loc_s32_sockfd, IEEE80211_IOCTL_STA_INFO, &loc_t_req) < 0)
		{
			perror("???: ioctl failed : unable to get station information\n");
		}
		else
		{
			loc_u32_len = loc_t_req.u.data.length;
			if (loc_u32_len >= sizeof(struct ieee80211req_sta_info))
			{
				loc_pu8_cp = pu8_buffer_req_sta_info; //RAZ
				do {
					loc_ps_sta_info = (struct ieee80211req_sta_info *) loc_pu8_cp; //RAZ
					loc_pu8_vp = (u8sod *)(loc_ps_sta_info+1);
					if(0 == loc_ps_sta_info->isi_txratekbps)
					{
						loc_u32_txrate = (loc_ps_sta_info->isi_rates[loc_ps_sta_info->isi_txrate] & IEEE80211_RATE_VAL)/2;
					}
					else
					{
						loc_u32_txrate = loc_ps_sta_info->isi_txratekbps / 1000;
					}
					memset(&loc_s_wifi_client, 0, sizeof(S_STRUCT_EXP_WIFI_CLIENT)); //RAZ
					for(loc_u8_i=0;loc_u8_i<ETHER_ADDR_LEN;loc_u8_i++)
					{
						loc_s_wifi_client.pu8_add_mac[loc_u8_i] = (u8sod)loc_ps_sta_info->isi_macaddr[loc_u8_i];
					}
					loc_s_wifi_client.s32_rssi_dbm = s32ConvertRssiToDBm((u32sod)loc_ps_sta_info->isi_rssi);
					loc_s_wifi_client.u8_present = TRUE; 
					loc_s_wifi_client.u8_flag_maj = TRUE;
					loc_s_wifi_client.u32_statut |= (u32sod)(1<<BIT1_STA_CLIENTWIFI_ASSOCIATED);
					if(FALSE == u8MajDonneesClientWifi(loc_ps_exp_accesspoint, &loc_s_wifi_client))
					{
						printf("WlanN_MiseAJour_TableClientsWifi: u8MajDonneesClientWifi KO\n");
					}
					else
					{
						loc_u16_nb_client ++;
					}
//				printf("MAC= %02X:%02X:%02X:%02X:%02X:%02X RSSI=%d \n",
//					   loc_ps_sta_info->isi_macaddr[0],
//					   loc_ps_sta_info->isi_macaddr[1],
//					   loc_ps_sta_info->isi_macaddr[2],
//					   loc_ps_sta_info->isi_macaddr[3],
//					   loc_ps_sta_info->isi_macaddr[4],
//					   loc_ps_sta_info->isi_macaddr[5],
//					   loc_ps_sta_info->isi_rssi);

					loc_pu8_cp += loc_ps_sta_info->isi_len; //environ 200 octets
					if(loc_u32_len > loc_ps_sta_info->isi_len)
					{
						loc_u32_len -= loc_ps_sta_info->isi_len;
					}
					else
					{
						loc_u32_len = 0; //on sort
					}
					loc_u16_cpt ++;
				} while((loc_u16_cpt < NB_ASSOCIATED_STATIONS_MAX) && 
						(loc_u32_len >= sizeof(struct ieee80211req_sta_info)));
			}
		}*///Modif by VuHai
		close(loc_s32_sockfd);
	}

	//On détermine le nombre de clients wifi connectés
	loc_ps_exp_accesspoint->u16_nb_associations = loc_u16_nb_client;
	
}/*WlanN_MiseAJour_TableClientsWifi*/


/*_____VII - PROCEDURE D'INITIALISATION __________________________________*/

//=====================================================================================
// Fonction		: InitModule_Exp_Wlan_N
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 14/09/2010 -
// Description	: Initialisation du module de exp_wlan_N
//=====================================================================================
void InitModule_Exp_Wlan_N(void)
{
	memset(pu8_buffer_req_sta_info, 0, TAILLE_MAX_BUFFER_REQ_STA_INFO); //INIT

}/*InitModule_Exp_Wlan_N*/

