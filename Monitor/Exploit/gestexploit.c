/*========================================================================*/
/* NOM DU FICHIER  : gestexploit.c 		                                  */
/*========================================================================*/
/* Compilateur     : GCC                                                  */
/* Linking locator : GCC                                                  */
/* Formatter       : GCC                                                  */
/* Auteur          : CM                                                   */
/* Date			   : 24/09/2009                                           */
/* Libelle         : Monitor: gestion exploit de l'équipement			  */
/* Projet          : WRM100                                               */
/* Indice          : BE058                                                */
/*========================================================================*/
/* Historique      :                                                      */
//BE000 24/09/09 CM
// - CREATION
//BE002 14/12/2009 CM
// - Ajout gestion mise à jour de l'application par ssh rcp
// - Récupération de la version du bootloader
//BE003 22/12/2009 CM
// - Ajout exploitation adresse IP/Mask des interfaces
//BE014 08/03/2010 CM
// - Modification gestion de l'exploitation
//	=> toute l'exploitation est calculée dans le processus 'monitor'.
//BE037 06/07/2010 CM
// - Ajout exploitation temperature 
// - Ajout exploitation du client NTP
//BE047 29/11/2010 CM
// - Gestion mode dégradé - connection à AP impossible en permanence suite à configuration wifi 
//BE050 09/12/2010 CM
// - Correction gestion NTP/SNTP
//BE054 11/01/2011 CM
// - Ajout gestion mode monitor
//BE058 21/01/2011 CM
// - Ajout dans exploitation du canal en cours (sur AP et STA)
// - Modification gestion exploitation wifi
/*========================================================================*/

/*_____I - COMMENTAIRES - DEFINITIONS -  REMARQUES _______________________*/

/*_____II - DEFINE SBIT __________________________________________________*/
#define _GESTEXPLOIT


/*_____III - INCLUDE - DIRECTIVES ________________________________________*/
#include "../headers.h"

/*_____IV - VARIABLES GLOBALES ___________________________________________*/

/*_____V - PROCEDURES ____________________________________________________*/

#ifdef _WRM100_N_SELECT
//=====================================================================================
// Fonction		: ExtractExploitWifiGeneral
// Entrees		: <loc_ps_config< : configuration (RAM) pour ce processus
// Sortie		: rien
// Auteur		: CM - 01/12/2010 -
// Description	: extraction exploitation Wifi (general)
//=====================================================================================
void ExtractExploitWifiGeneral(void)
{
	struct ieee80211req_get_userinfo loc_t_userinfo_tempo;
	memset(&loc_t_userinfo_tempo, 0, sizeof(struct ieee80211req_get_userinfo)); //INIT
	
	if(TRUE == u8WlanN_GetWifiUserInfo_Ioctl(&loc_t_userinfo_tempo))
	{
		t_driverWifiN_userinfo = loc_t_userinfo_tempo;
	}
//	printf("encours: %dMHz / canal=%d freq_radar=%d\n",
//		   loc_t_userinfo_tempo.u16_freq_MHz_inprogress,
//		   loc_t_userinfo_tempo.u8_ieee_inprogress,
//		   loc_t_userinfo_tempo.u16_freq_radar_found);

}/*ExtractExploitWifiGeneral*/
#endif

//=====================================================================================
// Fonction		: GestionExecExploitation
// Entrees		: <loc_ps_config< : configuration (RAM) pour ce processus
//				: <loc_ps_exploit<: exploitation (RAM) pour ce processus
// Sortie		: rien
// Auteur		: CM - 24/09/2009 -
// Description	: Gestion exploitation de l'équipement
//=====================================================================================
void GestionExecExploitation(S_STRUCT_CONFIGURATION *loc_ps_config, S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	u8sod loc_u8_chgt;

	loc_u8_chgt = FALSE;	//INIT
	
	//Gestion du Wifi
#ifdef _WRM100_N_SELECT
	//Au préalable
	ExtractExploitWifiGeneral();
#endif

	switch(loc_ps_config->s_gene.u8_mode_radio_modem)
	{
		case MODE_RADIO_MODEM_STATION:
			//Gestion Wifi
			if(TRUE == loc_ps_exploit->s_general.ps_interface[INTERFACE_WLAN].u8_presence) //CONDITION: interface WLAN présent
			{
				ExtractExploitWifiStation(loc_ps_config, loc_ps_exploit);
			}
			break;
		case MODE_RADIO_MODEM_ACCESS_POINT:
			if(TRUE == loc_ps_exploit->s_general.ps_interface[INTERFACE_WLAN].u8_presence) //CONDITION: interface WLAN présent
			{
				ExtractExploitWifiAccessPoint(loc_ps_config, loc_ps_exploit);
			}
			break;
		case MODE_RADIO_MODEM_MONITOR:
		default:
			break;
	}

	//Exploitation sous générale
	if(TRUE == u8FillExploitGeneralFile(&loc_ps_exploit->s_general))
	{	
		loc_u8_chgt = FALSE;	//RAZ
		//Gestion des paramètres d'exploitation des interfaces 
		if(TRUE == u8MiseAjour_ExploitInterfaces(loc_ps_config, loc_ps_exploit))//CONDITION: changement détectée
		{
			loc_u8_chgt = TRUE;	//chgt détecté
		}

		//Gestion des paramètres d'exploitation temperature
		if(TRUE == u8MiseAjour_ExploitTemperature(loc_ps_config, loc_ps_exploit))
		{
			loc_u8_chgt = TRUE;	//chgt détecté
		}
		
		//Ré-initialisation exploitation NTP/SNTP
		if(TRUE == s_cip_monitor_courant.u8_info_reconfig_time)
		{
			Raz_Exp_Ntp();	//RAZ		
			loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_PRINCIPAL] = FALSE;	//RAZ
			loc_ps_exploit->s_general.pu8_presence_serveur_ntp[SERVEUR_NTP_SECOURS] = FALSE;	//RAZ
			loc_u8_chgt = TRUE;	//chgt détecté
		}
		
		switch(loc_ps_config->s_admin.u8_mode_mah)
		{
			case MODE_MAH_NTP:
				//Gestion des paramètres d'exploitation NTP
				if(TRUE == MiseAjour_ExploitNTP(loc_ps_config, loc_ps_exploit))
				{
					loc_u8_chgt = TRUE;	//chgt détecté
				}
				break;
			case MODE_MAH_SNTP:
				//Gestion des paramètres d'exploitation SNTP
				if(TRUE == MiseAjour_ExploitSNTP(loc_ps_config, loc_ps_exploit))
				{
					loc_u8_chgt = TRUE;	//chgt détecté
				}
				break;
			case MODE_MAH_MANUELLE:
			default:
				break;
		}
		
		//Etape finale
		if(TRUE == loc_u8_chgt) //CONDITION: changement détecté
		{
			u8EditExploitGeneralFile(&loc_ps_exploit->s_general);
		}
	}
	
	//Gestion DHCP
	if((MODE_RADIO_MODEM_STATION == loc_ps_config->s_gene.u8_mode_radio_modem) &&
	   (MODE_NETWORK_ROUTER == loc_ps_config->s_gene.u8_mode_network) &&
	   (FCT_DHCP_SERVER == loc_ps_config->s_gene.u8_lan_fonction_dhcp)
	  )//CONDITION: STATION / router
	{
		if(TRUE == u8FillExploitDHCPFile(&loc_ps_exploit->s_dhcp))
		{
			GestionExploitDHCPServer(loc_ps_config, loc_ps_exploit);
			u8EditExploitDHCPFile(&loc_ps_exploit->s_dhcp);
		}

	}

}/*GestionExecExploitation*/

//=====================================================================================
// Fonction		: u8MiseAjour_ExploitTemperature
// Entrees		: <loc_ps_config< : configuration (RAM) pour ce processus
//				: <loc_ps_exploit<: exploitation (RAM) pour ce processus
// Sortie		: <loc_u8_chgt>: TRUE si chgt des infos exploit, sinon FALSE
// Auteur		: CM - 06/07/2010 -
// Description	: Mise à jour exploitation temperature
//=====================================================================================
u8sod u8MiseAjour_ExploitTemperature(S_STRUCT_CONFIGURATION *loc_ps_config, S_STRUCT_EXPLOITATION *loc_ps_exploit)
{
	u8sod	loc_u8_chgt;
	s32sod	loc_s32_temp;

	loc_u8_chgt = FALSE; //INIT
	loc_s32_temp = VALEUR_TEMPERATURE_INCONNUE;	//INIT


	loc_s32_temp = s32GetTemperature();
	if(loc_s32_temp != loc_ps_exploit->s_general.s32_temperature)
	{
		loc_ps_exploit->s_general.s32_temperature = loc_s32_temp;
		loc_u8_chgt = TRUE;
	}

	return loc_u8_chgt;
}/*MiseAjour_ExploitTemperature*/

/*_____VII - PROCEDURE D'INITIALISATION __________________________________*/

//=====================================================================================
// Fonction		: InitModule_GestExploit
// Entrees		: rien
// Sortie		: rien
// Auteur		: CM - 24/09/2009 -
// Description	: Initialisation du module de gestexploit
//=====================================================================================
void InitModule_GestExploit(void)
{
#ifdef _WRM100_N_SELECT
	memset(&t_driverWifiN_userinfo, 0, sizeof(struct ieee80211req_get_userinfo)); //INIT
	 ;
#endif
	
}/*InitModule_GestExploit*/

